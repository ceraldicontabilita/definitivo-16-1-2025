<analysis>**original_problem_statement:**
L'utente ha inizialmente richiesto un'applicazione ERP (Azienda Semplice) per la contabilità. Dopo l'implementazione di numerose funzionalità (dashboard, gestione scadenze, export PDF, importazione estratti conto) e un refactoring completo del codice, l'utente ha segnalato una serie di bug critici e richiesto ulteriori miglioramenti.

Le richieste principali includono:
- **Bug Critici:**
    1.  Il filtro dell'anno globale (nella barra blu) non funziona correttamente in diverse pagine, mostrando dati di anni non selezionati.
    2.  La pagina  mostra fatture di anni errati (es. 2025 in visualizzazione 2026).
    3.  La pagina  mostra sempre gli stessi dati indipendentemente dal mese selezionato.
    4.  Impossibilità di eliminare i dati di test da .
    5.  Le fatture importate da XML non devono essere cancellabili (il cestino deve essere nascosto).
    6.  La pagina  ha problemi con l'esportazione PDF e l'invio di email.
    7.  La pagina  mostra dati di anni sbagliati e il link al report non funziona come previsto.
- **Miglioramenti Funzionali:**
    1.  Implementare la formattazione numerica italiana (separatore migliaia, virgola per decimali) su tutti gli importi dell'applicazione.
    2.  Migliorare la logica di riconciliazione bancaria, automatizzando l'importazione di versamenti e bloccando la modifica dei movimenti riconciliati.
    3.  Implementare un visualizzatore di fatture XML in stile AssoInvoice.
    4.  Migliorare l'impaginazione del PDF generato dalla pagina .

**User's preferred language**: Italiano

**what currently exists?**
L'applicazione è stata sottoposta a un importante refactoring per ridurre la complessità del codice, passando da ~90 a 71 router backend. Successivamente, sono state implementate diverse correzioni e nuove funzionalità basate sul feedback dell'utente:
- **Filtro Anno Globale**: Tutte le pagine principali sono state modificate per utilizzare un contesto globale (), risolvendo parzialmente il bug del filtro dell'anno.
- **Parser PDF Estratto Conto**: È stata implementata una funzionalità backend () e frontend per l'importazione e l'analisi di estratti conto bancari in formato PDF.
- **Visualizzatore Fatture XML**: È stato creato un nuovo componente () che mostra un'anteprima dettagliata delle fatture in stile AssoInvoice.
- **Correzioni Varie**:
    - Risolto il bug  nella pagina .
    - Nascosto il pulsante di eliminazione per tutte le fatture importate da XML.
    - Ripristinata la pagina  che era stata eliminata per errore.
    - Migliorato il layout del PDF generato per i report.

**Last working item**:
- **Last item agent was working**: L'agente stava implementando la richiesta dell'utente di formattare tutti i numeri con il separatore delle migliaia e la virgola per i decimali (formato italiano). Ha iniziato applicando la funzione  in diverse sezioni della pagina .
- **Status**: IN PROGRESS
- **Agent Testing Done**: N
- **Which testing method agent to use?**:  per verificare la corretta formattazione degli importi su tutte le pagine dell'applicazione.
- **User Testing Done**: N

**All Pending/In progress Issue list**:
- **Issue 1: Dati Pagina IVA non si aggiornano (P0)**
    - **Attempted fixes**: L'agente ha verificato che l'endpoint backend  viene chiamato correttamente. Tuttavia, durante i test, ha notato che il database risulta vuoto, quindi l'endpoint restituisce sempre dati nulli.
    - **Next debug checklist**:
        1.  Verificare perché il database è vuoto nella sessione corrente. I dati sono in cache del browser dell'utente o non vengono persistiti correttamente?
        2.  Popolare il database con dati di test (es. importando fatture XML) per poter eseguire un debug reale.
        3.  Testare l'endpoint  con dati reali per assicurarsi che i filtri per anno e mese funzionino.
    - **Why fix this issue and what will be achieved with the fix?**: È un bug critico che rende inutilizzabile la funzionalità di analisi IVA.
    - **Status**: BLOCKED
    - **Is recurring issue?**: Y
    - **Should Test frontend/backend/both after fix?**: both
    - **Blocked on other issue**: Mancanza di dati persistenti nel database per il debug.

- **Issue 2: Impossibile eliminare movimenti di test (P2)**
    - **Attempted fixes**: L'agente ha tentato di replicare il problema ma non ha trovato movimenti da eliminare perché il database era vuoto.
    - **Next debug checklist**:
        1.  Risolvere il problema della persistenza dei dati.
        2.  Creare un movimento di test in .
        3.  Provare a eliminarlo e analizzare i log del backend per capire perché l'operazione fallisce (potrebbe essere legato alla logica in ).
    - **Why fix this issue and what will be achieved with the fix?**: Permetterà all'utente di pulire i dati di prova.
    - **Status**: BLOCKED
    - **Is recurring issue?**: Y
    - **Should Test frontend/backend/both after fix?**: backend
    - **Blocked on other issue**: Mancanza di dati persistenti nel database.

- **Issue 3: Logica di riconciliazione incompleta (P2)**
    - **Attempted fixes**: È stato aggiunto un pulsante per importare movimenti non riconciliati in .
    - **Next debug checklist**:
        1.  Implementare un endpoint che, dato un movimento da VERS. CONTANTI, lo inserisca in .
        2.  Modificare gli endpoint di riconciliazione per impostare un flag  sui documenti (fatture, movimenti, assegni).
        3.  Modificare gli endpoint di eliminazione per impedire la cancellazione dei documenti con .
    - **Why fix this issue and what will be achieved with this?**: Automatizzerà parte del lavoro di contabilità e garantirà l'integrità dei dati.
    - **Status**: NOT STARTED
    - **Is recurring issue?**: N
    - **Should Test frontend/backend/both after fix?**: both
    - **Blocked on other issue**: No.

**In progress Task List**:
- **Task 1: Completare la Formattazione Numerica (P0)**
    - **Where to resume**: L'agente ha quasi completato la pagina . Ora deve estendere la formattazione a tutte le altre pagine che mostrano importi: , , , , , , , etc., sostituendo  e  con la funzione  da .
    - **What will be achieved with this?**: L'intera applicazione userà una formattazione numerica consistente e corretta per la contabilità italiana.
    - **Status**: IN PROGRESS
    - **Should Test frontend/backend/both after fix?**: frontend
    - **Blocked on something**: No.

**Upcoming and Future Tasks**
- **Upcoming Tasks**:
    - **(P1) Verifica Completa Filtro Anno**: Anche se le pagine sono state aggiornate per usare , l'utente ha segnalato che il problema persiste. È necessaria una verifica end-to-end per assicurarsi che ogni chiamata API invii l'anno corretto e che non ci siano più selettori di anno locali.
    - **(P1) Logica Pagamento Fatture Miste**: Implementare la logica per cui, importando una fattura XML, se il fornitore ha metodo di pagamento misto, questo venga riconciliato con l'estratto conto.
- **Future Tasks**:
    - **(P2) Riconciliazione Automatica Bonifici**: Implementare una logica che abbini automaticamente i bonifici in uscita dall'estratto conto con le fatture da pagare.
    - **(P2) Grafici Interattivi Avanzati**: Aggiungere drill-down e filtri ai grafici della dashboard.
    - **(P2) Mapping Fatture → Piano dei Conti**: Creare una logica per categorizzare automaticamente le voci delle fatture nel piano dei conti.

**Completed work in this session**
- **Risoluzione Bug Anno Globale**: Tutte le pagine principali (, , , , etc.) sono state refattorizzate per utilizzare il contesto globale , rimuovendo gli stati locali dell'anno.
- **Visualizzatore Fatture Stile AssoInvoice**: Creato e integrato il componente  per mostrare un'anteprima dettagliata delle fatture XML.
- **Correzione Eliminazione Fatture**: La logica è stata perfezionata per nascondere il pulsante Elimina per tutte le fatture importate da XML, indipendentemente dal loro stato di pagamento.
- **Correzione PDF **: Risolto il bug di  e migliorata l'intestazione e la struttura del PDF generato.
- **Parser Estratti Conto Bancari**: Implementata con successo la funzionalità di upload e parsing di PDF di estratti conto.
- **UI/UX **: La tabella delle fatture è stata migliorata per mostrare la data prima del numero e per includere i documenti .

**Earlier issues found/mentioned but not fixed**
Nessuno. Tutti i problemi menzionati sono stati risolti o sono presenti nella lista dei problemi pendenti.

**Known issue recurrence from previous fork**
- **Discrepanza Anno Selezionato**: Questo problema è stato segnalato di nuovo dall'utente. L'agente ha eseguito un refactoring massiccio per forzare l'uso di  su tutte le pagine. Sebbene tecnicamente corretto, il problema sembra persistere dal punto di vista dell'utente, probabilmente a causa della mancanza di dati persistenti che impedisce una verifica reale.
- **Recurrence count**: 2
- **Status**: IN PROGRESS

**Code Architecture**


**Key Technical Concepts**
- **Global State (React Context)**:  è fondamentale per la coerenza dello stato dell'anno selezionato.
- **PDF Parsing (Backend)**: Utilizzo di  per l'estrazione di dati da documenti PDF.
- **PDF Generation (Frontend)**: Utilizzo di  e  per creare report lato client.
- **Data Persistence**: Problema critico attuale. Non è chiaro come i dati vengano salvati tra le sessioni, e il database appare vuoto.

**key DB schema**
- Le collezioni (, , etc.) dovrebbero esistere, ma l'agente le ha trovate vuote. È necessario verificare la connessione al DB e la strategia di persistenza dei dati.

**changes in tech stack**
- **Backend**: Aggiunta la libreria .

**All files of reference**
- **Creati**:
  - 
  - 
  - 
- **Modificati pesantemente**:
  - , , , , , , , ,  (per usare  e ).
  -  (refactoring router).
  -  (correzione endpoint).
  -  (aggiornato).

**Areas that need refactoring**:
- È necessario un refactoring a livello di codice per garantire l'uso consistente della funzione  in tutti i componenti che visualizzano valuta.

**key api endpoints**
- : (NUOVO) Esegue il parsing di un PDF di estratto conto.
- : (DA VERIFICARE) Endpoint che al momento restituisce dati vuoti.
- : (MODIFICATO) Recupera i dati di una singola fattura.

**Critical Info for New Agent**
- **Il problema più critico è la persistenza dei dati.** Il database sembra essere vuoto in ogni sessione. Non puoi debuggare la maggior parte dei bug segnalati dall'utente (filtro anno, dati IVA, eliminazione) senza dati reali. La tua prima azione deve essere capire perché il DB è vuoto e trovare un modo per popolarlo e far persistere i dati.
- La formattazione dei numeri è una priorità alta e deve essere applicata a livello globale.
- L'utente è molto attento ai dettagli. Assicurati di testare ogni modifica attentamente e di indirizzare ogni punto sollevato.

**documents and test reports created in this job**
- 
- 
- 

**Last 10 User Messages and any pending HUMAN messages**
1.  **LATEST**: L'utente segnala che la formattazione dei numeri è sbagliata (mancano separatore migliaia e decimali corretti), il filtro anno non funziona in , i dati  sono sempre uguali e ci sono problemi di visualizzazione nella tabella . **Stato: In corso di risoluzione.**
2.  L'utente chiede di migliorare l'impaginazione del PDF generato e di risolvere il bug del pulsante Elimina sulle fatture importate. **Stato: Completato.**
3.  L'utente segnala che il filtro dell'anno non funziona ancora correttamente e che la  mostra fatture di anni sbagliati. **Stato: Parzialmente risolto (refactoring ), ma da verificare.**
4.  L'utente approva il piano di correzione precedente. **Stato: Completato.**
5.  L'utente segnala una lunga lista di bug: problemi di riconciliazione, descrizione troncata, , e richiede un visualizzatore stile AssoInvoice. **Stato: Parzialmente risolto.**
6.  L'utente approva il lavoro precedente (fix anno e parser PDF). **Stato: Completato.**
7.  L'utente segnala il bug del controllo anno e richiede l'implementazione del parser per gli estratti conto PDF. **Stato: Completato.**

**Project Health Check:**
- **Broken**: Sì. Le funzionalità principali legate alla visualizzazione dei dati (IVA, filtri per anno) sono inaffidabili a causa di problemi di persistenza dei dati.
- **Mocked**: None.
- **Needs Cleanup**: Sì, è necessario completare il cleanup della formattazione numerica in tutto il frontend.

**3rd Party Integrations**
- : Per i grafici.
- : Per la generazione di PDF (backend).
- : Per il calcolo delle festività.
- : (Nuovo) Per il parsing di PDF.
- , : Per la generazione di PDF (frontend).

**Testing status**
- **Testing agent used after significant changes**: YES, ma i test sono passati senza dati reali nel DB, quindi non sono affidabili per i bug correnti.
- **Troubleshoot agent used after agent stuck in loop**: NO
- **Test files created**: File di test sono stati generati dal testing agent ma necessitano di essere eseguiti su un database popolato.
- **Known regressions**: Il problema del filtro dell'anno continua a essere segnalato nonostante i fix.

**Credentials to test flow:**
N/A

**What agent forgot to execute**
- L'agente non ha risolto il problema fondamentale della persistenza dei dati. Ha continuato a lavorare sui bug come se i dati fossero presenti, basandosi su screenshot dell'utente, ma non ha potuto verificare le proprie correzioni in modo affidabile. Questo ha portato a cicli di fix non verificabili.</analysis>
