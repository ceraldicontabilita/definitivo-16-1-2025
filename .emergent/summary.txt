<analysis>**original_problem_statement:**
L'utente ha richiesto una serie di funzionalità e correzioni per un'applicazione ERP. Le richieste più recenti si sono concentrate su:
1.  **Pagina Gestione Dipendenti:**
    *   Correggere la logica di importazione e ricalcolo dei saldi.
    *   Ottimizzare le prestazioni della pagina, che era diventata molto grande e lenta.
    *   Risolvere un bug che impediva la chiusura del modale Aggiusta Saldo.
    *   Risolvere un bug per cui il nome del dipendente appariva duplicato in varie sezioni.
    *   Risolvere un bug per cui il menu a tendina per la selezione del dipendente nei modali Nuovo Contratto e Libretti Sanitari risultava vuoto.
2.  **Pagina Documenti:**
    *   Ridurre il tempo di caricamento delle email, passando da un periodo di 4 anni agli ultimi 10 giorni.
    *   Aggiungere un campo per la ricerca di parole chiave personalizzate durante la sincronizzazione delle email.
    *   Ridurre il tempo di visualizzazione dei popup di caricamento.

**User's preferred language**: Italiano

**what currently exists?**
*   **Architettura Frontend Ottimizzata:** La pagina  è stata quasi completamente refattorizzata. Il componente originale, che superava le 2600 righe, è stato ridotto a meno di 400 righe e ora funge da contenitore per tab separati e ottimizzati.
*   **Componenti Tab Separati:** La logica e la UI per ciascun tab (Prima Nota Salari, Libro Unico, Contratti, Libretti Sanitari) sono state estratte in componenti dedicati (es. ).
*   **State Management Moderno:**
    *   **Zustand** è stato implementato per la gestione dello stato globale del tab Prima Nota Salari ().
    *   **@tanstack/react-query** è stato installato e configurato a livello di applicazione () per la gestione del caching e del data fetching delle API.
*   **Performance:** È stato implementato il **Code Splitting** con  e  per tutte le pagine principali, migliorando il tempo di caricamento iniziale dell'applicazione.
*   **Pagina Documenti:** La pagina  contiene la logica per la sincronizzazione delle email. L'agente ha identificato il codice da modificare per ridurre il periodo di sincronizzazione e ha già cambiato la variabile da 1460 a 10 giorni.

**Last working item**:
*   **Last item agent was working**: Implementazione delle richieste dell'utente per la pagina . Nello specifico, l'agente ha modificato il file  per ridurre il periodo di download delle email da 1460 a 10 giorni e si stava preparando ad aggiungere la funzionalità di ricerca per parole chiave personalizzate.
*   **Status**: IN PROGRESS
*   **Agent Testing Done**: N
*   **Which testing method agent to use?**: frontend testing agent. L'agente dovrà verificare la pagina  per assicurarsi che: 1. Il periodo di sincronizzazione delle email sia effettivamente ridotto. 2. L'interfaccia per aggiungere parole chiave personalizzate funzioni. 3. Il popup di caricamento abbia una durata ridotta come richiesto.
*   **User Testing Done**: N

**All Pending/In progress Issue list**:
*   **Issue 1: Il dropdown dei dipendenti nei modali è vuoto (P0)**
*   **Issue 2: Anno 2018 importato come 2005 (P1)**
*   **Issue 3: Parsing degli F24 scaricati da email fallisce (P2)**

**Issues Detail:**
-   **Issue 1: Il dropdown dei dipendenti nei modali è vuoto (P0)**
    -   **Attempted fixes**: L'agente ha diagnosticato il problema come un *timing issue*. I componenti dei tab (, ) vengono renderizzati e ricevono la prop  come un array vuoto, prima che la chiamata API nel componente padre () abbia terminato il caricamento dei dati. L'agente ha tentato di forzare il caricamento con un  aggiuntivo, ma senza successo.
    -   **Next debug checklist**:
        1.  Rimuovere il passaggio della prop  ai componenti dei tab.
        2.  Creare uno store globale (es. con Zustand o utilizzando React Query) per la lista dei dipendenti.
        3.  Fare in modo che  popoli questo store una sola volta.
        4.  Modificare i componenti  e  affinché leggano la lista dei dipendenti direttamente dallo store globale, garantendo che i dati siano sempre disponibili e aggiornati.
    -   **Why fix this issue and what will be achieved with this?**: È un bloccante critico che impedisce all'utente di creare nuovi contratti e libretti sanitari, due funzionalità fondamentali della pagina.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: frontend
    -   **Blocked on other issue**: no

-   **Issue 2: Anno 2018 importato come 2005 (P1)**
    -   **Attempted fixes**: Nessuno in questa sessione. Il problema non è stato riprodotto.
    -   **Next debug checklist**:
        1.  Chiedere all'utente il file Excel esatto che causa l'errore.
        2.  Chiedere uno screenshot della tabella dopo l'importazione.
        3.  Analizzare la logica di parsing dell'anno in .
    -   **Why fix this issue and what will be achieved with this?**: Garantisce l'integrità dei dati, che è fondamentale per tutti i calcoli successivi.
    -   **Status**: BLOCKED (in attesa di input dall'utente)
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: backend

-   **Issue 3: Parsing degli F24 scaricati da email fallisce (P2)**
    -   **Attempted fixes**: Nessuno. Ereditato dagli handoff precedenti.
    -   **Next debug checklist**:
        1.  Analizzare i log del backend durante il processo di F24 per identificare l'errore specifico.
        2.  Esaminare il codice Python responsabile del parsing dei file F24.
    -   **Why fix this issue and what will be achieved with this?**: Completerebbe una funzionalità di automazione importante per l'utente.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: backend

**In progress Task List**:
-   **Task 1: Completare le modifiche alla pagina Documenti (P0)**
    -   **Where to resume**: L'agente ha già modificato la variabile  a  in . I prossimi passi sono:
        1.  Implementare un campo di input nell'UI per permettere all'utente di inserire parole chiave personalizzate per la ricerca.
        2.  Modificare la funzione  per includere queste parole chiave nella ricerca IMAP.
        3.  Investigare come ridurre la percezione della durata del popup di caricamento (es. mostrando un feedback più granulare o eseguendo l'operazione in background).
    -   **What will be achieved with this?**: Si risponderà alle richieste dirette dell'utente, migliorando l'usabilità e le prestazioni della sincronizzazione dei documenti.
    -   **Status**: IN PROGRESS
    -   **Should Test frontend/backend/both after fix?**: frontend
    -   **Blocked on something**: No.

**Upcoming and Future Tasks**
*   **Upcoming Tasks**:
    *   **(P1) Re-implementare la virtualizzazione delle tabelle:** Reintrodurre  (o una libreria simile) nella tabella di  per ottimizzare il rendering di liste lunghe. L'implementazione precedente era stata rimossa a causa di un problema di compatibilità.
    *   **(P1) Finalizzare il refactoring dei tab:** Migrare la logica di data-fetching e state-management dei tab ,  e  per utilizzare  e/o Zustand, seguendo il pattern stabilito per .
*   **Future Tasks**:
    *   **(P2) Refactoring critico dei router backend:** Eliminare i file di routing duplicati in  per risolvere un debito tecnico che potrebbe causare bug.
    *   **(P2) Completare la logica della pagina :** Implementare la funzionalità dei pulsanti Azioni per spostare i documenti processati.
    *   **(P3) Centralizzare tutti gli upload:** Creare una pagina di upload generica.

**Completed work in this session**
- **Refactoring Massivo e Ottimizzazione Prestazioni:**
  - Il componente  è stato ridotto da 2627 a ~374 righe (-86%), estraendo la logica dei tab in componenti separati e ottimizzati.
  - Implementato un'architettura moderna con **Zustand** per lo state management (), **@tanstack/react-query** per il caching delle API, e **Code Splitting** con  per il caricamento on-demand delle pagine.
- **Bug Fix Critici:**
  - Risolto il problema dei pulsanti di esclusione anni (2018-2022) che non aggiornavano i saldi. È stato corretto un bug che usava una variabile  non definita.
  - Risolto il bug del modale Aggiusta Saldo che non si chiudeva.
  - Risolto il bug dei nomi duplicati, standardizzando l'uso del campo  (formato Cognome Nome) in tutta l'applicazione.
- **Miglioramenti UI/UX:**
  - Rimosso il pulsante Ricalcola Progressivi dal 2023 come richiesto.

**Earlier issues found/mentioned but not fixed**
- **Issue 1: Test automatici  falliscono:** Ereditato dall'handoff precedente, non affrontato.
- **Issue 2: Definire e completare la funzionalità Vincolo:** La logica esatta deve ancora essere confermata con l'utente.

**Known issue recurrence from previous fork**
- **Issue recurrence in previous fork**: **File di routing duplicati nel backend**. Sebbene non abbia causato problemi in questa sessione, il debito tecnico rimane e rappresenta un rischio.
- **Recurrence count**: 0
- **Status**: NOT STARTED

**Code Architecture**


**Key Technical Concepts**
- **State Management (Zustand):** Utilizzato per gestire lo stato complesso del tab Prima Nota Salari in modo centralizzato e reattivo.
- **Data Fetching & Caching (@tanstack/react-query):** Implementato per gestire le chiamate API in modo efficiente, riducendo le richieste di rete e gestendo stati di caricamento/errore.
- **Performance Optimization (Code Splitting):**  e  sono stati usati per caricare i componenti delle pagine solo quando necessario, accelerando il caricamento iniziale.
- **Component-Driven Refactoring:** Un monolite UI () è stato scomposto in componenti più piccoli, specializzati e manutenibili.
- **Custom Hooks:** Utilizzati per estrarre e riutilizzare la logica di business e di interazione con lo stato.

**key DB schema**
-   **prima_nota_salari**: 
-   **dipendenti**: 

**changes in tech stack**
-   **Aggiunti (Frontend):** , , .

**All files of reference**
-   : Componente padre, ora notevolmente snellito.
-   : File target per le prossime modifiche richieste dall'utente.
-   : Punto di ingresso dell'app, ora configurato con  e  per il lazy loading.
-   **Nuova Architettura:** Le directory , , , e  contengono il cuore della nuova logica refattorizzata.

**Areas that need refactoring**:
-   **Componenti dei Tab:** I componenti , , e  dovrebbero essere ulteriormente refattorizzati per utilizzare  e custom hooks, allineandosi all'architettura di .
-   **Virtualizzazione:** La virtualizzazione della tabella in  con  deve essere ripristinata correttamente per gestire grandi quantità di dati in modo performante.
-   **Backend Routers (CRITICO):** La duplicazione dei file di routing nel backend () è un debito tecnico che deve essere risolto per evitare bug e inconsistente.

**key api endpoints**
-   : Recupera la lista dei dipendenti.
-   : Ricalcola i saldi progressivi.
-   : Avvia la sincronizzazione delle email (utilizzato in ).

**Critical Info for New Agent**
-   **Architettura Nuova:** L'applicazione ha subito un importante refactoring. Il nuovo pattern da seguire è: componenti piccoli, custom hooks per la logica, e gestione dello stato/dati con Zustand e React Query.
-   **Priorità Utente:** Le richieste immediate dell'utente sono sulla pagina : ridurre il periodo di sincronizzazione email a 10 giorni (già fatto), aggiungere un campo di ricerca per keyword, e ridurre il tempo dei popup.
-   **Bloccante Esistente:** Il bug del dropdown vuoto nei modali Nuovo Contratto e Libretti Sanitari è un problema critico da risolvere. La causa è un *timing issue* nel passaggio delle props. La soluzione migliore è usare uno store globale (Zustand/React Query) per la lista dei dipendenti, invece di passarla tramite props.

**documents and test reports created in this job**
-    è stato aggiornato più volte per l'esecuzione del testing agent.
-   Sono stati creati numerosi file per la nuova architettura frontend (componenti, hooks, store).

**Last 10 User Messages and any pending HUMAN messages**
1.  **Utente (Msg 498):** Richiesta di modificare la pagina  (ridurre sync email a 10 giorni, aggiungere ricerca keyword, ridurre tempo popup) e ha menzionato il problema del dropdown vuoto. **Stato: IN PROGRESS.**
2.  **Utente (Msg 380):** Riporta la duplicazione del nome del dipendente nei contratti e documenti. **Stato: COMPLETATO.**
3.  **Utente (Msg 379):** Chiede di correggere il layout dei contratti e documenti. **Stato: COMPLETATO.**
4.  **Utente (Msg 306):** Approva il piano di ottimizzazione completo proposto dall'agente. **Stato: COMPLETATO.**
5.  **Utente (Msg 278):** Chiede di procedere con le altre ottimizzazioni dopo il primo refactoring. **Stato: COMPLETATO.**
6.  **Utente (Msg 130):** Dice all'agente di continuare con il refactoring. **Stato: COMPLETATO.**
7.  **Utente (Msg 117):** Approva l'inizio del refactoring del componente . **Stato: COMPLETATO.**
8.  **Utente (Msg 110):** Fornisce una lista dettagliata di tecniche di ottimizzazione React da implementare. **Stato: IN PROGRESS (parzialmente completato).**
9.  **Utente (Msg 45):** Segnala che i saldi non cambiano con i bottoni di esclusione e chiede di rimuovere un altro bottone. **Stato: COMPLETATO.**
10. **Utente (Msg 5):** Segnala che i bottoni di ricalcolo (2018-2022) non funzionano. **Stato: COMPLETATO.**

**Project Health Check:**
*   **Broken**:
    *   La creazione di nuovi contratti e libretti sanitari è bloccata a causa del dropdown dei dipendenti vuoto.
    *   L'architettura del backend presenta ancora file di routing duplicati, un rischio per la stabilità a lungo termine.
*   **Mocked**: Nessuno.

**3rd Party Integrations**
*   **Google/Gmail (IMAP)**: Per scaricare email e allegati.
*   **pdfplumber**: Per estrarre dati da file PDF.
*   **pandas/openpyxl**: Per leggere e scrivere file Excel.
*   **Nuove librerie frontend:**
    *   : State management.
    *   : Data fetching e caching.
    *   : Per la virtualizzazione di liste (installata ma temporaneamente non utilizzata).

**Testing status**
-   **Testing agent used after significant changes**: YES (utilizzato con successo dopo ogni fase principale del refactoring).
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: Nessuno.
-   **Known regressions**: Nessuna regressione nota introdotta in questa sessione.

**Credentials to test flow:**
-   **Email User**: 
-   **Email App Password**:  (disponibile in  come ).

**What agent forgot to execute**
-   L'agente non ha creato un task specifico per re-implementare la virtualizzazione con  dopo averla temporaneamente rimossa per risolvere un bug di importazione. Questo era parte del piano di ottimizzazione approvato dall'utente.
-   Dopo aver diagnosticato il problema del dropdown vuoto, l'agente è stato reindirizzato dall'utente a un altro task prima di poter implementare una soluzione robusta, lasciando la funzionalità bloccata.</analysis>
