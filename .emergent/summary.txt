<analysis>**original_problem_statement:**
L'utente ha richiesto una serie di interventi mirati a risolvere bug specifici, migliorare le performance e unificare funzionalità ridondanti. Le richieste chiave sono:
1.  **Ottimizzazione delle Performance**: Risolvere la lentezza nel caricamento di tutte le pagine, in particolare ,  e .
2.  **Unificazione Pagine**: Unificare le pagine  e  in un'unica interfaccia, eliminando la ridondanza.
3.  **Correzione Bug Fornitori**: Investigare e correggere il motivo per cui il conteggio dei fornitori era sceso da ~250 a 100, e perché fatture del 2022 erano presenti nonostante un fornitore non potesse essere eliminato se associato a fatture.
4.  **Correzione Bug Filtro Anno**: Il selettore dell'anno nella barra laterale non aggiorna correttamente i dati visualizzati nelle pagine.
5.  **Correzione Bug UI Prima Nota**:
    *   Il movimento Incasso POS appare nella colonna AVERE invece che DARE.
    *   Nel popup di modifica di un movimento, il campo Categoria deve contenere le stesse opzioni del form di inserimento, e il campo Descrizione non deve essere obbligatorio, ma pre-compilato con il nome del tipo di movimento.
6.  **Correzione Bug Logica Corrispettivi**: Quando si carica un file XML di corrispettivi, i dati estratti sovrascrivono gli importi inseriti manualmente (es. incassi POS).
7.  **Gestione Documenti Email con Nomi Duplicati**: Implementare una logica per riconoscere e gestire correttamente i file allegati alle email che hanno lo stesso nome ma contenuto diverso (es.  inviato ogni mese).

PRODUCT REQUIREMENTS:
- L'applicazione deve essere veloce e reattiva, con tempi di caricamento delle pagine inferiori a 2 secondi.
- Le funzionalità duplicate devono essere unificate per migliorare l'esperienza utente e la manutenibilità.
- Tutti i dati visualizzati devono essere consistenti con il database e riflettere correttamente i filtri applicati (es. anno).
- La logica di business deve essere robusta, prevenendo la perdita di dati inseriti manualmente durante le importazioni automatiche.
- La logica di importazione dei documenti deve essere immune a errori derivanti da nomi file identici per periodi diversi.

**User's preferred language**: Italiano

**what currently exists?**
L'agente ha eseguito una sessione intensiva di ottimizzazione e bug fixing.
-   **Performance**: Sono state ottimizzate le query più lente (, , ) tramite indici MongoDB, caching lato server e paginazione, con miglioramenti della velocità fino a 183x.
-   **Logica Email**: È stato implementato un sistema di riconoscimento intelligente dei documenti via email, che estrae il periodo (mese/anno) dal contenuto del file per evitare di scartare documenti con nomi identici ma periodi diversi.
-   **Unificazione DB**: Le collection  e  sono state unificate in un'unica collection , con migrazione dei dati esistenti.
-   **Bug Fixing Iniziato**: Sono state implementate le correzioni per la maggior parte dei bug segnalati dall'utente, tra cui:
    -   Logica di aggregazione dei fornitori da due collection distinte ( e ).
    -   Correzione della direzione del movimento POS in entrata (DARE).
    -   Aggiornamento della logica di importazione dei corrispettivi XML per non sovrascrivere i dati manuali.
    -   Modifiche al modal di modifica della prima nota.
-   **Nuova Pagina**: È stata creata da zero la pagina  con la relativa logica frontend.
-   **Refactoring UI**: È stato avviato il lavoro di unificazione delle pagine  e .

**Last working item**:
-   **Last item agent was working**: Unificazione delle pagine  e . L'agente ha aggiunto una struttura a schede (Tabs) alla pagina  e ha iniziato a migrare le funzionalità dalla pagina  nelle nuove schede Pipeline e Scadenze.
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: testing_agent_v3_fork (data la complessità delle modifiche UI che impattano più componenti e flussi di dati).
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1**: (P0) Completare l'unificazione delle pagine  e .
-   **Issue 2**: (P1) Correggere il bug per cui il filtro dell'anno nella barra laterale non aggiorna i dati in tutte le pagine.
-   **Issue 3**: (P1) Correggere la visualizzazione del movimento POS nella prima nota e migliorare il popup di modifica.
-   **Issue 4**: (P2) Verificare che la logica di importazione dei corrispettivi XML non sovrascriva più i dati manuali.
-   **Issue 5**: (P2) Verificare che il conteggio dei fornitori (255) sia corretto e che l'utente comprenda la logica di aggregazione dalle due collection.

**Issues Detail**:
-   **Issue 1: Unificazione Pagine Ciclo Passivo**
    -   **Attempted fixes**: L'agente ha modificato  aggiungendo la struttura a  e il codice base per le nuove sezioni.
    -   **Next debug checklist**:
        1.  Completare la migrazione dei componenti e della logica per le schede Pipeline e Scadenze da  a .
        2.  Collegare le chiamate API necessarie per popolare i dati delle nuove schede.
        3.  Rimuovere la vecchia route  da .
        4.  Eliminare il file .
        5.  Testare approfonditamente la nuova pagina unificata.
    -   **Why fix this issue and what will be achieved with the fix?**: Per soddisfare la richiesta dell'utente di eliminare la ridondanza e semplificare l'interfaccia.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: Frontend
    -   **Blocked on other issue**: No.

-   **Issue 2: Bug Filtro Anno Globale**
    -   **Attempted fixes**: L'agente ha modificato l'hook  e la pagina  per usare l'anno globale dal contesto e forzare un  più alto.
    -   **Next debug checklist**:
        1.  Navigare tra diverse pagine (Fornitori, Fatture, Dashboard).
        2.  Cambiare l'anno dalla barra laterale.
        3.  Verificare che i dati visualizzati in TUTTE le sezioni della pagina si aggiornino per riflettere l'anno selezionato.
        4.  Controllare la console per errori e le chiamate di rete per verificare che il parametro  sia passato correttamente.
    -   **Why fix this issue and what will be achieved with the fix?**: Ripristina una funzionalità di navigazione fondamentale per l'utente.
    -   **Status**: TESTING PENDING
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Frontend
    -   **Blocked on other issue**: No.

-   **Issue 3: Bug UI Prima Nota**
    -   **Attempted fixes**: L'agente ha modificato : ha cambiato la  del POS in , ha aggiornato il modal di modifica per includere le categorie e ha modificato la logica della descrizione.
    -   **Next debug checklist**:
        1.  Verificare nella tabella della prima nota che un movimento Incasso POS appaia nella colonna DARE.
        2.  Cliccare su Modifica di un movimento: verificare che il campo  sia un dropdown con le stesse opzioni del form di inserimento.
        3.  Verificare che cambiando la categoria, la descrizione venga pre-compilata e non sia un campo obbligatorio.
    -   **Why fix this issue and what will be achieved with the fix?**: Migliora l'accuratezza contabile e l'usabilità di una schermata fondamentale.
    -   **Status**: TESTING PENDING
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Frontend
    -   **Blocked on other issue**: No.

**In progress Task List**:
-   **Task 1: Unificazione delle pagine del ciclo passivo**
    -   **Where to resume**: Continuare a modificare il file , implementando la logica e la visualizzazione per le schede Pipeline e Scadenze.
    -   **What will be achieved with this?**: Si otterrà un'unica pagina per la gestione delle fatture passive, dalla consultazione all'intero workflow operativo.
    -   **Status**: IN PROGRESS
    -   **Should Test frontend/backend/both after fix?**: Frontend
    -   **Blocked on something**: No.

**Upcoming and Future Tasks**
-   **Future Tasks (messi in attesa su richiesta dell'utente)**:
    -   Integrazione Google Calendar per le scadenze.
    -   Implementazione di una Dashboard Analytics con grafici interattivi.
    -   Schedulazione per l'invio automatico di report PDF via email.

**Completed work in this session**
-   **Ottimizzazione Massiva delle Performance**:
    -   Aggiunti 31 indici a diverse collection MongoDB.
    -   Implementato caching lato server per endpoint critici (, , ).
    -   Ridotto il  di default nelle query e implementata paginazione, portando la velocità di  da 1.6s a 0.05s (32x) e  da 5.5s a 0.03s (183x).
-   **Logica di Importazione Email Avanzata**:
    -   Modificato  per estrarre il periodo (mese/anno) da F24, cedolini, IVA e bonifici, usando una chiave composta (categoria + periodo) per prevenire la scarto di documenti con nome file identico.
-   **Unificazione Collection Database**:
    -   Migrati i dati da  a .
    -   Aggiornati tutti i router (, , ) per usare solo la collection .
-   **Correzione Bug Multipli**:
    -   Aggregati correttamente i dati dalle collection  e  nell'endpoint , portando il conteggio visualizzato da 100 a 255.
    -   Corretta la logica di  dei corrispettivi per non sovrascrivere i campi inseriti manualmente.
-   **Sviluppo Frontend**:
    -   Creata e testata la pagina .
    -   Aggiunto il link per la chiusura esercizio nel menu laterale.

**Earlier issues found/mentioned but not fixed**
-   Nessuno, i problemi menzionati sono stati affrontati e sono ora in fase di test/verifica.

**Known issue recurrence from previous fork**
-   Nessuno.

**Code Architecture**


**Key Technical Concepts**
-   **Performance Optimization**: MongoDB Indexing, Server-Side Caching (in-memory dictionary), Aggregation Pipelines, Server-Side Pagination.
-   **Data Migration**: Scripting  e  per migrare e trasformare dati tra collection.
-   **Semantic Duplicate Detection**: Utilizzo di parsing del contenuto e chiavi composite (es.  + ) per identificare duplicati logici, superando il semplice hash del file.
-   **UI Refactoring**: Unificazione di componenti React complessi tramite una struttura a schede (Tabs) per ridurre la ridondanza e migliorare la user experience.

**key DB schema**
-   ****: Collection unificata che ora contiene sia i cedolini calcolati manualmente sia quelli importati da PDF (precedentemente in ).
-   ** / **: Coesistono due collection per i fornitori. L'endpoint  è stato modificato per aggregare i dati da entrambe, ma questo rimane un punto di debito tecnico.
-   ****: Ora contiene un campo  (es. 2026_01) per la logica di de-duplicazione semantica.

**changes in tech stack**
-   Nessuna.

**All files of reference**
-    (pesantemente ottimizzato)
-    (pesantemente ottimizzato)
-    (logica di de-duplicazione implementata)
-    (in fase di refactoring)
-    (bug UI corretti)
-    (bug di sovrascrittura corretto)
-    (nuovo script di migrazione)

**Areas that need refactoring**:
-   **Pagine Ciclo Passivo**: Il refactoring per unificare  e  è in corso. Al termine, il file  dovrà essere eliminato.
-   **Collection Fornitori**: Le collection  e  dovrebbero essere migrate in un'unica collection per eliminare il debito tecnico e semplificare le query.

**key api endpoints**
-   : Ottimizzato da 5.5s a <0.1s.
-   : Ottimizzato da 1.9s a <0.1s con caching.
-   : Ottimizzato da 0.6s a <0.1s con caching e logica di aggregazione corretta.
-   : Logica di aggiornamento modificata per preservare dati manuali.

**Critical Info for New Agent**
-   L'utente è molto attento e segnala bug multipli e dettagliati in un unico messaggio. È fondamentale analizzare ogni punto e affrontarlo in modo sistematico.
-   Le performance sono una priorità assoluta. Tutte le nuove query e pagine devono essere progettate per essere veloci, utilizzando caching e paginazione dove appropriato.
-   Le correzioni implementate (filtro anno, UI prima nota, import corrispettivi) necessitano di una verifica pratica e di un test end-to-end prima di poter essere considerate concluse.
-   Il lavoro di unificazione delle pagine del ciclo passivo è a metà. Bisogna completarlo come priorità assoluta (P0).

**documents and test reports created in this job**
-   
-   
-   
-    (aggiornato)

**Last 10 User Messages and any pending HUMAN messages**
-   **10. (In Progress)** L'utente ha segnalato una serie di problemi: timeout in , lentezza della dashboard, ha chiesto le differenze tra  e  e ha chiesto di unificarle. Ha anche segnalato bug sul conteggio dei fornitori, sul filtro dell'anno, sulla UI della prima nota (colonna POS e modal modifica) e sulla logica di import dei corrispettivi.
-   **9.** I task futuri lasciamoli sospesi fin quando non te li chiedo io - L'utente chiede di mettere in pausa lo sviluppo di nuove funzionalità. (COMPLETED)
-   **8.** Questa scenario può accadere anche per PDF iva... procedi con unificare cedolini - L'utente chiede di estendere la logica di riconoscimento dei documenti duplicati a tutti i tipi di file e di procedere con l'unificazione delle collection /. (COMPLETED)
-   **7.** L'utente chiede una soluzione per il problema delle email con allegati che hanno lo stesso nome (es. ) ma si riferiscono a mesi diversi. (COMPLETED)
-   **6.** L'utente chiede una spiegazione dettagliata del flusso logico che si attiva quando vengono scaricati F24 e cedolini da Gmail. (COMPLETED)
-   **5.** L'utente approva il piano di creare la pagina per la Chiusura Esercizio e unificare / (P0 e P1), e richiede test approfonditi. (COMPLETED)
-   **4.** L'agente propone di creare la pagina frontend per la Chiusura Esercizio. (COMPLETED)
-   **3.** L'utente approva il piano di audit sistematico (P0). (COMPLETED)
-   **2.** L'agente chiede all'utente di approvare il piano di lavoro. (COMPLETED)
-   **1.** L'utente chiede un audit sistematico completo dell'applicazione con test basati su scenari reali. (COMPLETED)

**Project Health Check:**
-   **Broken**:
    -   Il filtro dell'anno globale non funziona in modo consistente su tutte le pagine.
    -   La pagina  è soggetta a timeout a causa del caricamento inefficiente di dati nel frontend.
-   **Mocked**:
    -   Nessuno.
-   **Technical Debt**:
    -   **High**: Due collection distinte per i fornitori ( e ). Sebbene l'API le unisca, una migrazione a livello di database sarebbe la soluzione definitiva.
    -   **In Progress**: Unificazione delle pagine  e .

**3rd Party Integrations**
-    (fitz)
-   
-   
-   
-   
-   
-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting 

-----
-   Telegram Bot API
-   usage: websockets [--version | <uri>]

**Testing status**
-   **Testing agent used after significant changes**: YES (usato per validare l'unificazione delle collection  e altre modifiche al backend).
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**:  (script di migrazione).
-   **Known regressions**: Nessuna nota.

**Credentials to test flow:**
-   Non sono necessarie credenziali specifiche per l'accesso base.

**What agent forgot to execute**
-   L'agente non ha completato l'unificazione delle pagine  e .
-   L'agente non ha eseguito una verifica completa e un test end-to-end di tutti i bug specifici segnalati dall'utente nel suo ultimo messaggio (filtro anno, UI prima nota, ecc.) dopo aver implementato le correzioni.</analysis>
