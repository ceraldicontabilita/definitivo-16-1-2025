<analysis>**original_problem_statement:**
L'utente ha richiesto l'aggiunta di diverse funzionalità a un'applicazione ERP:
1.  **Funzionalità di Produzione e Lotti**: Implementare un sistema per la produzione basata su ricette, con generazione di codici di lotto e tracciabilità degli ingredienti.
2.  **Riconciliazione F24 a 3 Livelli**:
    *   Download automatico di F24 via email da commercialisti/consulenti.
    *   Parsing dei PDF F24 (sia quietanze di pagamento che modelli F24 del commercialista).
    *   Creazione di una dashboard per riconciliare i pagamenti, confrontando i modelli F24 con le quietanze, e segnalando lo stato di ogni tributo (Pagato, Da Pagare, In Scadenza).
3.  **Parsing Buste Paga**: Estrarre dati dai PDF delle buste paga.
4.  **Calcolo Liquidazione IVA**: Integrare un modulo fornito dall'utente per il calcolo dell'IVA mensile e la generazione di un report PDF.
5.  **Comparatore Prezzi Fornitori**: Integrare la logica fornita per confrontare i prezzi dei prodotti tra diversi fornitori, includendo una normalizzazione basata su AI.

**User's preferred language**: Italiano

**what currently exists?**
-   **Modulo Produzione e Lotti**: Completamente implementato (backend e frontend).
-   **Modulo Liquidazione IVA**: Completamente implementato (backend e frontend), basato sul codice fornito dall'utente.
-   **Modulo Buste Paga**: Il parser per i PDF Zucchetti () e il relativo router API () sono stati integrati. L'endpoint per l'upload è funzionante.
-   **Modulo Comparatore Prezzi**: La logica del comparatore è stata integrata nel router esistente ().
-   **Modulo Riconciliazione F24**:
    *   **Download Email**: Servizio per scaricare allegati PDF da Gmail funzionante.
    *   **Parser Quietanze F24**: Funzionante ().
    *   **Parser F24 Commercialista/Consulente**: Funzionante per vari formati, ma con un bug di aggregazione in fase di correzione.
    *   **Backend Riconciliazione**: Le API per la dashboard e la verifica dello stato dei pagamenti sono implementate.
    *   **Frontend Dashboard**: La pagina  è stata creata e visualizza correttamente i dati forniti dal backend.

**Last working item**:
-   **Last item agent was working**: Correzione di un bug critico nel parser F24 del consulente del lavoro (). L'utente ha segnalato che il parser accorpava erroneamente righe di tributo con lo stesso codice ma anni o periodi diversi (es. due righe per il codice 3802 venivano sommate), impedendo una corretta riconciliazione per singolo tributo/periodo.
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: N (Il test stava per essere eseguito dopo la modifica del codice)
-   **Which testing method agent to use?**: manual testing by curl. L'agente deve eseguire un test mirato sul parser aggiornato usando il file  per verificare che ogni riga di tributo venga estratta come un elemento separato.
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
-   **Issue 1: Il parser F24 aggrega le righe di tributo invece di leggerle singolarmente (P0)**
-   **Issue 2: Click sui tab non funzionante nei test automatici in  (P2)**

**Issues Detail:**
-   **Issue 1:**
    -   **Attempted fixes**: L'agente ha identificato che il problema era l'approccio di cercare pattern in modo sequenziale. Ha refattorizzato il codice in  per usare un singolo pattern  con , con l'obiettivo di iterare su tutte le righe di tributo presenti nel testo del PDF e creare un record per ciascuna.
    -   **Next debug checklist**:
        1.  Eseguire uno script di test per invocare la funzione  con il file  (proveniente da ).
        2.  Verificare che l'output (il dizionario ) contenga una lista separata di tributi per ogni riga, specialmente per i codici 3802 (che appare due volte) e per tutti i codici segnalati dall'utente (1631, 1704, 3797, 3847, 3848).
        3.  Se il test locale passa, ricaricare il PDF tramite l'API  e verificare che la dashboard  mostri correttamente tutti i tributi non accorpati.
    -   **Why fix this issue and what will be achieved with this?**: Per garantire l'accuratezza della riconciliazione F24, che è una funzionalità core richiesta. L'utente deve poter tracciare lo stato di ogni singolo versamento per codice tributo e periodo.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: N
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on other issue**: None
-   **Issue 2:**
    -   **Attempted fixes**: Nessuno in questa sessione.
    -   **Next debug checklist**: Eseguire il  specificamente sulla pagina  per replicare il problema e analizzare l'interazione con i componenti Tab di .
    -   **Why fix this issue and what will be achieved with this?**: Sbloccare test E2E affidabili per una parte critica dell'applicazione.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: frontend
    -   **Blocked on other issue**: None

**In progress Task List**:
Nessuno.

**Upcoming and Future Tasks**
-   **(P0) Testare il parsing delle buste paga**: L'utente deve fornire file PDF di buste paga per testare il parser  appena integrato.
-   **(P1) Valutare integrazione bancaria**: Completare l'analisi di Salt Edge o alternative (Plaid, Tink, Fabrick) per la riconciliazione con l'estratto conto bancario (Livello 3 del flusso F24).
-   **(P2) Implementare la logica F24 Sostitutivi**: Aggiungere la gestione degli F24 con ravvedimento, segnalando le versioni precedenti come obsolete.
-   **(P3) UI per il Comparatore Prezzi**: Integrare la funzionalità del comparatore prezzi nella pagina frontend .

**Future Tasks**:
-   Gestire l'inventario fisico e la .
-   Costruire una dashboard di controllo di gestione completa e avanzata.
-   Aggiungere gestione delle non conformità ai record di tracciabilità.

**Completed work in this session**
-   **Modulo Liquidazione IVA Mensile**: Integrato codice fornito dall'utente, creato API backend e pagina frontend dedicata. Funzionalità testata con successo.
-   **Integrazione di 3 moduli forniti dall'utente**:
    1.  **Parser Buste Paga Zucchetti**: Integrato il servizio  e l'API .
    2.  **Database Codici Tributo**: Integrato il servizio .
    3.  **Comparatore Prezzi**: Integrata la logica nel router esistente .
-   **Frontend per Dashboard Riconciliazione F24**: Creata la pagina  che mostra lo stato degli F24 caricati.
-   **Miglioramento Parser F24**: Migliorata significativamente la robustezza del parser  per gestire diversi formati di PDF, inclusi quelli basati su form, passando a metodi di estrazione testo più avanzati ().

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Click sui tab non funzionante nei test automatici in **. Problema ricorrente non ancora affrontato.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork**: Il fallimento dei test automatici su .
-   **Recurrence count**: 3+
-   **Status**: NOT STARTED

**Code Architecture**


**Key Technical Concepts**
-   **Debugging Frontend (Vite)**: L'agente ha affrontato un complesso problema di debug sul frontend. Inizialmente ha sospettato un errore di alias (), poi un errore , ma la causa principale si è rivelata essere uno stato instabile del server di sviluppo Vite, risolto solo dopo aver riavviato e testato incrementalmente i componenti.
-   **Refactoring del Parser PDF**: Di fronte a un bug segnalato dall'utente, l'agente è passato da un approccio di parsing basato su  (che trova solo la prima corrispondenza) a uno basato su  per iterare su *tutte* le corrispondenze di un pattern, risolvendo così un problema di aggregazione dati.
-   **Estrazione Testo da PDF Complessi**: L'agente ha imparato che  può fallire con PDF basati su form. Ha quindi adottato metodi più robusti come  e  per estrarre dati da layout non testuali.
-   **Gestione dei Conflitti di Routing**: L'agente ha identificato e risolto un conflitto di routing in FastAPI causato dalla creazione di un nuovo router () con un prefisso già in uso da un router esistente ().

**key DB schema**
-   **f24_commercialista**: 
-   **buste_paga**: 

**All files of reference**
-   : File chiave per la risoluzione del bug corrente.
-   : Router che utilizza i dati del parser.
-   : Pagina frontend che visualizzerà i dati corretti.
-   : Parser per le buste paga, in attesa di file di test.

**Critical Info for New Agent**
-   La priorità assoluta (P0) è risolvere il bug di aggregazione nel parser . La soluzione proposta (usare ) è corretta concettualmente, ma deve essere testata a fondo per assicurarsi che ogni riga di tributo dal PDF venga salvata come un oggetto separato nell'array  del documento MongoDB.
-   L'utente è molto attento e tecnico. Si aspetta che i dati siano accurati al 100%. Non accorpare o sommare nulla che non sia esplicitamente richiesto. Ogni riga sull'F24 è un'entità a sé.
-   L'intero ecosistema frontend (Vite, React) si è dimostrato sensibile a problemi di cache. In caso di errori inspiegabili sulla UI, una pulizia della cache () e un riavvio completo del servizio  è un buon primo passo.
-   Per testare il parser buste paga (), dovrai chiedere all'utente di fornire uno o più file PDF di esempio.

**documents and test reports created in this job**
-    (Test Liquidazione IVA)
-    (Test integrazione 3 moduli)
-    (Test Dashboard Riconciliazione F24)
-   File PDF caricati dall'utente in  per il testing dei parser F24.

**Last 10 User Messages and any pending HUMAN messages**
10. L'utente ha segnalato che il parser F24 sta erroneamente accorpando più righe di tributo in una sola e che mancano diversi codici. Ha chiesto di leggere ogni riga separatamente. (PENDING FIX)
9.  L'utente ha chiesto di spiegare e parsare un F24 del consulente del lavoro. (COMPLETED, but buggy)
8.  L'utente ha fornito un PDF di un F24 per l'IVA di Novembre e ha chiesto di caricarlo. (COMPLETED)
7.  L'utente ha chiesto di continuare a lavorare sulla Riconciliazione F24. (IN PROGRESS)
6.  L'utente ha chiesto di integrare 3 file Python che ha caricato: un parser buste paga, un database di codici tributo e un comparatore prezzi. (COMPLETED)
5.  L'utente ha caricato i 3 file Python. (COMPLETED)
4.  L'utente ha chiesto di integrare il modulo , usare la collezione  esistente e di valutare Salt Edge. (COMPLETED)
3.  L'utente ha fornito il file . (COMPLETED)
2.  In attesa della risposta dell'utente al piano proposto dall'agente.
1.  L'agente ha chiesto conferma del suo piano all'utente.

**Project Health Check:**
-   **Broken**: La funzionalità di parsing degli F24 del consulente è parzialmente rotta a causa del bug di aggregazione.
-   **Mocked**: Nessuna.

**3rd Party Integrations**
-   **Google/Gmail (IMAP)**: Per il download degli allegati F24.
-   **pdfplumber**: Nuova dipendenza aggiunta per il parsing dei PDF delle buste paga.

**Testing status**
-   **Testing agent used after significant changes**: YES (usato più volte per Liquidazione IVA, integrazione moduli, e Riconciliazione F24).
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: , , .
-   **Known regressions**: Il parser  ha avuto una regressione funzionale (parsing errato) dopo l'introduzione di un PDF con un nuovo formato, che ha poi rivelato un bug logico più profondo (aggregazione).

**Credentials to test flow:**
-   **Email User**: 
-   **Email App Password**: 
-   (Queste credenziali sono nel file )

**What agent forgot to execute**
L'agente non ha dimenticato nulla, ma ha introdotto un bug logico nel parser F24 nel tentativo di gestire un nuovo formato di file. L'errore è stato correttamente identificato dall'utente e l'agente ha iniziato il processo di refactoring per correggerlo.</analysis>
