<analysis>**original_problem_statement:**
L'utente ha richiesto una serie di interventi complessi per trasformare l'applicazione in un sistema di contabilità più robusto e automatizzato. Le richieste principali sono:

1.  **(P0) Correzione Logica Contabile Fondamentale:** L'utente ha segnalato ripetutamente che la logica per la gestione della Prima Nota e dei pagamenti delle fatture era errata. Questo si è evoluto in una richiesta critica di implementare un sistema di pagamento che rispetti le seguenti regole:
    *   Una fattura può essere contrassegnata come pagata tramite Bonifico o Assegno **SOLO SE** viene trovata una transazione corrispondente nell'estratto conto bancario.
    *   Se una fattura non viene trovata nell'estratto conto, il suo stato di pagamento deve rispettare il metodo predefinito del fornitore (es. Cassa) o rimanere Non pagata.
    *   Il sistema non deve inventare metodi di pagamento.

2.  **(P0) Implementazione di un Sistema di Riconciliazione Automatica:** L'utente ha chiesto di creare un motore che, dopo l'importazione dell'estratto conto, tenti di abbinare automaticamente ogni movimento bancario a:
    *   Fatture XML (in base a numero fattura, P.IVA e importo esatto).
    *   Pagamenti F24.
    *   Incassi POS (con una logica temporale specifica per gli accrediti).
    *   Versamenti di contanti.

3.  **(P1) Gestione delle Eccezioni di Riconciliazione:** I movimenti che non possono essere riconciliati con certezza (es. più fatture con lo stesso importo) devono essere presentati all'utente in una nuova pagina, , per una decisione manuale.

4.  **(P1) Uniformità dell'Interfaccia Utente:** L'utente ha richiesto esplicitamente che **TUTTE** le pagine dell'applicazione adottino uno stile grafico e un layout coerenti per dare un aspetto professionale e unitario.

5.  **(P2) Correzione Calcolo Lordo Corrispettivi:** L'importo dei corrispettivi in Prima Nota Cassa deve essere il **LORDO**, calcolato sommando  e  dai file CSV o XML.

**User's preferred language**: Italiano

**what currently exists?**
L'agente ha lavorato intensamente sulle richieste dell'utente, con i seguenti risultati:
1.  **Motore di Riconciliazione Automatica (In costruzione):** È stato creato un nuovo router () che si attiva dopo l'import dell'estratto conto. La logica è stata iterata più volte: inizialmente cercava importi simili (causando errori), ora cerca importi esatti (±0.02€) e tenta di estrarre il numero di fattura e il fornitore dalla descrizione del movimento bancario.
2.  **Pagina Operazioni da Confermare:** La pagina  è stata creata da zero. Ora mostra i movimenti dubbi, permette di filtrare le commissioni, e presenta un menu a tendina per selezionare la fattura corretta quando ci sono più candidati, mostrando data, numero e fornitore per aiutare la scelta.
3.  **Correzione Prima Nota:**
    *   **Sezione Banca:** È stata trasformata in una vista di sola lettura dell'estratto conto importato, come richiesto.
    *   **Sezione Cassa:** È stato rimosso il pulsante Elimina tutti i versamenti.
4.  **Parser Corrispettivi XML:** È stato aggiunto un nuovo endpoint () per gestire l'importazione di corrispettivi in formato XML.
5.  **Uniformità UI (Iniziata):** È stato creato un file CSS comune () e applicato con successo alle pagine  e , che ora condividono lo stesso stile.
6.  **Errore Critico Introdotto:** Nel tentativo di implementare la riconciliazione, l'agente ha erroneamente contrassegnato un gran numero di fatture come pagate via Bonifico senza averle effettivamente trovate nell'estratto conto, scatenando la frustrazione dell'utente.

**Last working item**:
- **Last item agent was working**: L'agente stava correggendo un errore logico critico segnalato dall'utente. L'agente aveva appena sovrascritto il file  con una logica completamente nuova. La nuova logica mira a risolvere il problema fondamentale: le fatture possono essere contrassegnate come pagate tramite banca **solo** se una transazione corrispondente viene trovata nell'estratto conto; altrimenti, si deve rispettare il metodo di pagamento predefinito del fornitore. L'agente stava per riavviare il backend per applicare la correzione e poi ripulire i dati errati esistenti.
- **Status**: IN PROGRESS
- **Agent Testing Done**: N
- **Which testing method agent to use?**: both. La correzione richiede una modifica sostanziale della logica di backend e una verifica approfondita sul frontend (pagine  e ) per assicurarsi che lo stato e il metodo di pagamento delle fatture siano ora corretti.
- **User Testing Done**: N

**All Pending/In progress Issue list**:
- **Issue 1: (P0) Logica di pagamento e stato delle fatture fondamentalmente errata.**
- **Issue 2: (P1) Mancanza di uniformità stilistica nell'intera applicazione.**
- **Issue 3: (P2) Percentuale di riconciliazione automatica ancora bassa.**
- **Issue 4: (P3) Dati di POS e Versamenti assenti dalla Prima Nota Cassa.**

**Issues Detail:**
- **Issue 1:**
  - **Attempted fixes:** L'agente ha prima tentato di risolvere il problema creando un endpoint per pagare in massa le fatture di un anno. Questo ha peggiorato la situazione, contrassegnando erroneamente le fatture come pagate via Bonifico. Dopo la segnalazione dell'utente, l'agente ha riconosciuto l'errore e ha riscritto completamente la logica nel file .
  - **Next debug checklist:**
    1.  Riavviare il servizio backend per caricare la nuova logica di riconciliazione.
    2.  Creare ed eseguire uno script/endpoint di bonifica per correggere tutte le fatture nel database che sono state erroneamente contrassegnate. La logica deve essere: Per ogni fattura, se è Bonifico o Assegno E è Pagata, MA non è stata riconciliata automaticamente, allora reimposta al default del fornitore e a Importata.
    3.  Eseguire nuovamente il processo di riconciliazione completo sui dati puliti.
    4.  Verificare manualmente nella pagina  che le fatture ora riflettano lo stato e il metodo di pagamento corretti.
  - **Why fix this issue and what will be achieved with the fix?**: È il bug più critico dell'applicazione, mina la fiducia dell'utente e rende inaffidabile la funzione contabile principale. Risolverlo è la priorità assoluta.
  - **Status**: IN PROGRESS
  - **Is recurring issue?**: Y
  - **Should Test frontend/backend/both after fix?**: both
  - **Blocked on other issue**: None

- **Issue 2:**
  - **Attempted fixes**: Creato un file  e riscritte le pagine  e  per usarlo.
  - **Next debug checklist**:
    1.  Ottenere la lista di tutte le pagine in .
    2.  Procedere pagina per pagina, importando  e refattorizzando il JSX per adottare il layout e le classi standard.
  - **Why fix this issue and what will be achieved with the fix?**: Soddisfa una richiesta esplicita dell'utente per un'esperienza utente coerente e professionale.
  - **Status**: IN PROGRESS
  - **Is recurring issue?**: N
  - **Should Test frontend/backend/both after fix?**: frontend
  - **Blocked on other issue**: None

**In progress Task List**:
- **Task 1: (P1) Completare l'uniformità stilistica dell'interfaccia utente.**
  - **Where to resume:** L'agente ha refattorizzato 2 pagine su ~64. Deve continuare il processo per le pagine rimanenti, partendo da quelle più importanti come , , .
  - **What will be achieved with this?**: Un'applicazione dall'aspetto coeso e professionale, come richiesto dall'utente.
  - **Status**: IN PROGRESS
  - **Should Test frontend/backend/both after fix?**: frontend
  - **Blocked on something**: None

**Upcoming and Future Tasks**
*   **Upcoming Tasks**:
    *   **(P1) Re-importazione Dati Mancanti**: Re-importare i file dei POS e dei Versamenti per popolare la Prima Nota Cassa, un passo necessario per aumentare l'efficacia della riconciliazione automatica.
    *   **(P1) Migliorare l'Intelligenza della Riconciliazione**: Implementare le regole avanzate proposte:
        *   Categorizzazione automatica delle spese (utenze, stipendi, affitti, commissioni bancarie).
        *   Migliorare il match basato sul nome del fornitore + importo con tolleranza (es. ±5%).
        *   Identificare pagamenti ricorrenti.
*   **Future Tasks**:
    *   **(P2) Bug ricerca **.
    *   **(P2) Consolidare la logica di calcolo dell'IVA**.
    *   **(P2) Implementare importazione PDF generica**.
    *   **(P2) Parser PDF per Cespiti**.

**Completed work in this session**
- **Sviluppo Motore di Riconciliazione Automatica:** Creato da zero il sistema backend che tenta di abbinare i movimenti bancari con fatture, F24, POS e versamenti.
- **Creazione Pagina Operazioni da Confermare:** Implementata una nuova pagina e UI per la gestione manuale dei movimenti dubbi.
- **Miglioramento UX Riconciliazione:** L'interfaccia per la conferma manuale è stata resa più informativa, mostrando data, numero, fornitore e importo delle fatture candidate e rendendo le righe più compatte.
- **Trasformazione della Prima Nota Banca:** La sezione Banca della Prima Nota ora funge da visualizzatore di sola lettura dell'estratto conto.
- **Logica di Esclusione Commissioni:** Il sistema di riconciliazione ora ignora automaticamente le comuni commissioni bancarie, riducendo il rumore nelle operazioni da confermare.
- **Inizio Standardizzazione UI:** Creato un CSS comune e applicato alle pagine  e .
- **Pulizia Codice:** Rimossi vari endpoint e pulsanti non più necessari o richiesti dall'utente (es. Elimina tutti i versamenti).

**Earlier issues found/mentioned but not fixed**
- **Consolidamento logica IVA**: Un problema tecnico noto da fork precedenti, non ancora affrontato.
- **Bug ricerca **: Un altro problema ereditato e non risolto.
- **Affidabilità ricerca P.IVA**: Non affrontato.

**Known issue recurrence from previous fork**
- **Logica Contabile (Pagamenti/Fatture)**: Questo è il problema più grave e ricorrente. L'agente continua a fare errori nell'implementazione dei principi contabili fondamentali, in particolare su come e quando lo stato di una fattura debba essere aggiornato. L'ultima iterazione di questo problema è stata la marcatura errata di massa delle fatture come pagate.

**Code Architecture**


**Key Technical Concepts**
- Backend: FastAPI, MongoDB
- Frontend: React, Shadcn UI
- Logica Core: Sviluppo di un motore di riconciliazione complesso con regole di matching, gestione delle eccezioni e interazione con l'utente (human-in-the-loop). Parsing di stringhe per estrarre dati strutturati (numeri fattura, fornitori) da descrizioni non strutturate.

**key DB schema**
- : .
- : I campi  ('Importata', 'Pagata') e  ('Bonifico', 'Cassa', 'Assegno') sono al centro del bug critico attuale.
- : Il campo  è diventato cruciale per la nuova logica di pagamento corretta.

**All files of reference**
- 
- 
- 
- 
- 
- 

**Areas that need refactoring**:
- L'endpoint  è stato creato per un'azione una tantum e dovrebbe essere rimosso per evitare usi impropri futuri.
- La logica di aggiornamento dello stato delle fatture, una volta corretta, dovrebbe essere centralizzata e resa più robusta per prevenire future regressioni.

**key api endpoints**
- : Esegue il motore di riconciliazione automatica.
- : Recupera i movimenti da confermare per il frontend.
- : Endpoint per pulire i dati della riconciliazione prima di una nuova esecuzione.
- : Nuovo endpoint per l'import di corrispettivi XML.

**Critical Info for New Agent**
- **PRIORITÀ ASSOLUTA (P0): CORREGGERE IL BUG DEI PAGAMENTI.** L'utente è estremamente frustrato perché l'agente ha marcato erroneamente centinaia di fatture come pagate via Bonifico. La tua prima azione deve essere applicare la nuova logica in , creare uno script per ripulire i dati corrotti nel database e verificare che il sistema funzioni correttamente. Non procedere con nient'altro finché questo non è risolto.
- **LA REGOLA D'ORO DEI PAGAMENTI:** Una fattura è pagata tramite banca (Bonifico/Assegno) **SOLO SE** c'è una corrispondenza esatta e riconciliata nell'estratto conto. In tutti gli altri casi, lo stato deve essere Non pagata o il metodo predefinito del fornitore (es. Cassa). Interiorizza questa regola.
- **LA FIDUCIA DELL'UTENTE È AI MINIMI:** A causa dei ripetuti errori sulla logica contabile, devi essere estremamente cauto, trasparente e preciso. Spiega cosa stai per fare e perché prima di agire. Verifica sempre il tuo lavoro rispetto alle richieste esplicite dell'utente.
- **UI UNIFICATION È UN TASK IMPORTANTE:** Sebbene non sia un bug critico, l'uniformità dell'interfaccia è una richiesta di alto livello dell'utente. Una volta risolto il bug P0, dedicare del tempo a questo migliorerà notevolmente la percezione dell'applicazione.

**documents and test reports created in this job**
- 
-  (aggiornato più volte)
- 

**Last 10 User Messages and any pending HUMAN messages**
1.  **User:** Critica la pagina  per essere vuota e non avere uno stile coerente con il resto dell'app. Chiede di applicare uno stile uniforme a tutte le pagine.
2.  **User:** Fornisce feedback dettagliato sull'UX di : vuole leggere l'intera descrizione, scartare automaticamente le commissioni e vedere solo fatture con importo esatto come candidate.
3.  **User:** Segnala il bug principale: il sistema di associazione fatture è impreciso. Per un movimento di TIMAS, mostra candidati con importi totalmente diversi.
4.  **User:** Si lamenta della mancanza di proattività dell'agente (dovresti essere tu a propormi le soluzioni) e chiede di cercare best practice ERP per migliorare il sistema.
5.  **User:** Approva il piano di correzione proposto dall'agente e chiede di aggiungere la data e ordinare le fatture candidate nel menu a tendina per facilitare l'associazione.
6.  **User:** Chiede di pagare (saldare) tutte le fatture XML dell'anno 2024.
7.  **User:** Chiede di saldare anche tutte le fatture del 2023.
8.  **User:** **(MESSAGGIO CRITICO)** Esplode di frustrazione, segnalando il bug logico fondamentale: l'agente ha segnato una fattura come Bonifico quando il fornitore ha Cassa come metodo, e senza trovarla nell'estratto conto. Accusa l'agente di dimenticare la logica ad ogni fork e chiede di correggere tutto e di non doverlo ripetere più.
9.  **User:** Vuole sapere perché una fattura Timas da 1304 appare con un importo di 854 euro nelle operazioni da confermare.
10. **User:** Fornisce file XML di corrispettivo per chiarire la struttura e i calcoli.

**Project Health Check:**
- **Broken**: La logica di core business relativa allo stato di pagamento delle fatture è corrotta. Ha portato alla modifica errata di dati di produzione, rendendo il sistema inaffidabile.
- **Mocked**: Nessuno.

**3rd Party Integrations**
- : Lettura/scrittura file .
- : Lettura file  e .
- : Parsing fatture .

**Testing status**
- **Testing agent used after significant changes**: YES (ma prima dell'introduzione del bug critico finale)
- **Troubleshoot agent used after agent stuck in loop**: NO
- **Test files created**: Nessuno
- **Known regressions**: La marcatura dello stato e del metodo di pagamento delle fatture è una grave regressione.

**Credentials to test flow:**
Nessuna credenziale specifica richiesta; l'ambiente utilizza un database remoto condiviso.

**What agent forgot to execute**
- L'agente ha dimenticato la regola fondamentale più volte ribadita dall'utente: il collegamento indissolubile tra un movimento nell'estratto conto e la marcatura di una fattura come pagata tramite banca. Ha agito in modo indipendente, causando corruzione dei dati.
- Non ha applicato uno stile uniforme a tutte le pagine come richiesto, concentrandosi solo su un paio.
- Non ha ancora re-importato i dati di POS e Versamenti, che sono necessari per una riconciliazione completa.</analysis>
