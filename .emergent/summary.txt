<analysis>**original_problem_statement:**
L'utente ha richiesto una serie di funzionalità e correzioni di bug per un'applicazione ERP. Le richieste più recenti si concentrano su:
1.  **Pagina Gestione Dipendenti:**
    *   Correggere il calcolo del saldo progressivo, che non si aggiornava correttamente dopo le eliminazioni e non gestiva correttamente i totali a cavallo degli anni.
    *   Implementare una logica di calcolo del saldo progressivo configurabile (l'utente ha cambiato più volte idea, arrivando a richiedere un calcolo che parte da una data specifica, 01/01/2023).
    *   Aggiungere una funzionalità per inserire righe di aggiustamento manuali per allineare i saldi.
    *   Aggiungere un pulsante per ricalcolare i progressivi per un singolo dipendente a partire dal 01/01/2023, mostrando solo i record pertinenti dopo il ricalcolo.
    *   Risolvere una discrepanza nell'importazione di un file Excel di paghe (), dove il sistema importa 1017 record aggregati invece di 1165 righe, perché aggrega (somma) i pagamenti multipli per lo stesso dipendente nello stesso mese/anno. L'utente ha dichiarato che le righe non sono duplicati e sono corrette, indicando che si aspetta un record per ogni riga.

2.  **Pagina Documenti:**
    *   Estendere il periodo di ricerca email per il download dei documenti al 01/01/2021.
    *   Implementare un sistema di parole chiave configurabili (es. Cartella Esattoriale) per la ricerca di allegati email, che crei dinamicamente delle cartelle per i documenti scaricati.
    *   Chiarire il significato e la funzione dei campi Stato e Azioni nella tabella dei documenti.

**User's preferred language**: Italiano

**what currently exists?**
*   **Gestione Dipendenti:** La pagina  ora include una sezione Prima Nota Salari con funzionalità avanzate. È stato implementato un pulsante per ricalcolare i progressivi di un dipendente specifico a partire dal 01/01/2023, che filtra anche la vista. È stata aggiunta una funzione per inserire righe di aggiustamento saldo tramite un modale. Il problema di aggiornamento dei saldi dopo l'eliminazione è stato risolto aggiungendo  alle chiamate di ricaricamento dati. L'importazione delle paghe attualmente aggrega (somma) le righe con lo stesso .
*   **Bug Corretti:** Il bug dei bottoni verdi in  che non mostravano l'importo è stato risolto. L'errore 403 sull'upload di F24 è stato risolto rimuovendo l'autenticazione dagli endpoint.
*   **Pagina Documenti:** La pagina  è stata aggiornata per permettere la ricerca di email fino al 2021 e per gestire una lista di parole chiave personalizzabili. Il backend ora crea cartelle dinamiche basate su queste parole chiave.
*   **Problema Architetturale:** Esiste un grave problema di file di routing duplicati (es. in  e ), che ha causato diversi bug e confusione durante lo sviluppo.

**Last working item**:
*   **Last item agent was working**: L'agente stava cercando di risolvere la confusione dell'utente riguardo all'importazione del file . L'utente ha importato un file con 1165 righe ma il sistema ha creato 1017 record. L'agente ha scoperto che la logica attuale aggrega e somma le righe con la stessa combinazione di Dipendente, Mese e Anno. L'utente ha dichiarato non sono duplicati sono corretti, implicando che si aspetta un record separato per ogni riga del file, non un'aggregazione.
*   **Status**: BLOCKED
*   **Agent Testing Done**: Y (L'agente ha verificato che la logica di aggregazione funziona come progettato, ma questo non corrisponde alle aspettative dell'utente).
*   **Which testing method agent to use?**: Manual testing by user. Prima, l'agente deve modificare la logica di importazione per creare un record per ogni riga, come richiesto dall'utente.
*   **User Testing Done**: Y (L'utente ha testato l'import e ha segnalato che il numero di record non è corretto).

**All Pending/In progress Issue list**:
*   **Issue 1: Logica di importazione paghe errata (P0)**
*   **Issue 2: Discrepanza calcolo IVA a credito (P1)**
*   **Issue 3: Parsing degli F24 scaricati da email fallisce (P1)**
*   **Issue 4: Click sui tab non funzionante nei test automatici in  (P2)**

**Issues Detail:**
-   **Issue 1: Logica di importazione paghe errata (P0)**
    -   **Attempted fixes**: L'agente ha analizzato la logica esistente, confermando che aggrega (somma) le righe con lo stesso . Questa logica non soddisfa l'utente. L'agente ha svuotato il database per permettere all'utente di riprovare, ma il risultato è stato lo stesso.
    -   **Next debug checklist**:
        1.  Modificare la logica di importazione in .
        2.  Invece di cercare un record esistente per aggiornarlo ( con ), la logica deve usare sempre  per creare un nuovo record per ogni riga del file Excel.
        3.  Assicurarsi che ogni nuovo record abbia un uid=0(root) gid=0(root) groups=0(root) univoco (es. ).
        4.  La funzione  dovrà gestire correttamente record multipli per lo stesso mese.
    -   **Why fix this issue and what will be achieved with this?**: Per allineare il funzionamento dell'importazione alle aspettative dell'utente e importare correttamente tutti i dati di pagamento.
    -   **Status**: BLOCKED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: backend
    -   **Blocked on other issue**: None

-   **Issue 2: Discrepanza calcolo IVA a credito (P1)**
    -   **Attempted fixes**: L'agente ha analizzato la logica e ha concluso che la differenza tra  e  è intenzionale: la prima include le deroghe temporali (fatture del mese precedente registrate entro il 15), la seconda no.
    -   **Next debug checklist**:
        1.  Presentare questa scoperta all'utente tramite .
        2.  Chiedere se desidera allineare i calcoli (rendendo anche la vista annuale conforme alla liquidazione ufficiale) o se preferisce mantenere le due viste distinte, magari con una nota esplicativa nell'UI.
    -   **Why fix this issue and what will be achieved with this?**: Garantisce che l'utente comprenda i dati fiscali e che l'applicazione sia coerente o che le differenze siano chiaramente spiegate.
    -   **Status**: USER VERIFICATION PENDING
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: none (decisione di design)
    -   **Blocked on other issue**: None

-   **Issue 3: Parsing degli F24 scaricati da email fallisce (P1)**
    -   **Attempted fixes**: Nessuno in questa sessione.
    -   **Next debug checklist**: Ereditato dal precedente handoff.
        1.  Usare l'endpoint  per rieseguire il parsing.
        2.  Aggiungere logging dettagliato in  per catturare l'eccezione esatta.
        3.  Analizzare uno dei PDF falliti in .
    -   **Why fix this issue and what will be achieved with this?**: Completa una funzionalità di automazione chiave richiesta dall'utente.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: backend
    -   **Blocked on other issue**: None

-   **Issue 4: Click sui tab non funzionante nei test automatici in  (P2)**
    -   **Attempted fixes**: Nessuno. Problema ereditato.
    -   **Next debug checklist**: Eseguire il  sulla pagina.
    -   **Why fix this issue and what will be achieved with this?**: Sblocca test E2E affidabili.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: frontend
    -   **Blocked on other issue**: None

**In progress Task List**:
-   **Task 1: Centralizzare tutti gli upload in un'unica pagina (P1)**
    -   **Where to resume**: Questo task, richiesto nel precedente handoff, non è stato avviato. I passaggi includono la ridenominazione di , la creazione di un componente di upload generico e la rimozione dei pulsanti di upload dalle altre pagine.
    -   **What will be achieved with this?**: Semplificazione dell'interfaccia utente.
    -   **Status**: NOT STARTED
    -   **Should Test frontend/backend/both after fix?**: both
    -   **Blocked on something**: Le priorità dell'utente si sono spostate su altri task.

**Upcoming and Future Tasks**
*   **Upcoming Tasks**:
    *   **Refactoring backend (P0):** Eliminare i file di routing duplicati (es. tra  e ). Questo è CRITICO per evitare futuri bug.
    *   **Completare logica  (P1):** Implementare la funzionalità effettiva dei pulsanti Azioni per spostare i documenti processati nelle sezioni corrette dell'ERP (es. F24, Estratti Conto).

**Completed work in this session**
-   **Bug Fix: Saldo A Credito in :** I bottoni verdi ora mostrano correttamente l'importo a credito.
-   **Bug Fix: Errore 403 Upload F24:** Risolto rimuovendo l'autenticazione dall'endpoint di upload.
-   **Feature: Gestione Avanzata Salari Dipendenti:**
    *   Implementato un pulsante in  per ricalcolare il saldo progressivo di un dipendente dal 01/01/2023.
    *   Aggiunta una funzione per inserire righe di aggiustamento saldo per correzioni manuali.
    *   Corretto un bug per cui i saldi non si aggiornavano in tempo reale dopo un'eliminazione.
-   **Feature: Download Documenti da Email:**
    *   Esteso il periodo di ricerca email al 01/01/2021.
    *   Implementata una UI e un backend per la gestione di parole chiave di ricerca personalizzate.
    *   Aggiunta la logica per creare cartelle dinamiche per i documenti scaricati in base alla parola chiave.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Parsing F24 da email:** Il sistema scarica i file ma fallisce nel processarli. Questo problema è in attesa.
-   **Issue 2: Test automatici :** I test falliscono a causa di un problema nel cliccare i tab.

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork**: **File di routing duplicati**. L'agente è caduto di nuovo in questa trappola, modificando il file sbagliato () invece di quello corretto ().
-   **Recurrence count**: 1 (in questa sessione, ma è un problema sistemico).
-   **Status**: NOT STARTED. Il refactoring per eliminare i duplicati è essenziale.

**Code Architecture**


**Key Technical Concepts**
-   **Logica di Importazione Dati da Excel:** L'agente ha implementato una logica per leggere file  usando , raggruppare i dati e aggiornare il database MongoDB. La logica attuale aggrega i dati, ma deve essere modificata per creare record individuali.
-   **Gestione dello Stato Complesso in React:** La pagina  utilizza numerosi  e  per gestire filtri, dati della tabella, modali e chiamate API asincrone. La mancanza di  ha causato bug di aggiornamento della UI.
-   **Architettura con File Duplicati:** La presenza di file con lo stesso nome in diverse directory ( e ) è una fonte costante di bug difficili da diagnosticare. Il file corretto è quello importato nel modulo  in .

**key DB schema**
-   **prima_nota_salari**: 

**changes in tech stack**
- Nessuna.

**All files of reference**
-   : Il file di routing corretto per la gestione dei salari.
-   : La pagina frontend con la logica per la gestione dei salari.
-   : La pagina frontend per il download dei documenti.
-   : Il servizio backend per scaricare documenti da email.
-   : Il router per la gestione dei documenti scaricati.
-   : Per verificare quali router sono effettivamente inclusi nell'applicazione.

**Areas that need refactoring**:
-   **CRITICO:** La struttura della directory  deve essere bonificata. Tutti i file duplicati o obsoleti devono essere eliminati per stabilire una singola fonte di verità e prevenire futuri errori di debug.

**key api endpoints**
-   : Ricalcola i progressivi per un dipendente (modificato per accettare  e ).
-   : Aggiunge un record di aggiustamento manuale.
-   : Endpoint per l'importazione del file  (la cui logica è da modificare).
-   : Avvia il download da email (modificato per accettare  e ).
-   : Nuovi endpoint per gestire la lista di parole chiave.

**Critical Info for New Agent**
-   **Priorità Utente:** La priorità assoluta è risolvere la logica di importazione delle paghe (Issue 1). L'utente si aspetta che ogni riga del file Excel crei un record separato, mentre la logica attuale aggrega le righe. Devi modificare il backend per creare un record per ogni riga.
-   **ARCHITETTURA DUPLICATA:** Fai la massima attenzione ai file duplicati in . Prima di modificare un file di routing, controlla in  quale viene effettivamente importato. Il file corretto per i salari è . Si consiglia vivamente di proporre un refactoring per eliminare i duplicati.
-   **Discrepanza IVA:** L'analisi suggerisce che la discrepanza IVA è intenzionale. Devi confermarlo con l'utente e decidere come procedere.

**documents and test reports created in this job**
-    (aggiornato)

**Last 10 User Messages and any pending HUMAN messages**
10. **Utente (PENDING):** Si lamenta che l'importazione delle paghe crea sempre 1017 record, anche se il file ne ha di più. Chiede di poter reimportare anche i bonifici. (Status: In attesa di correzione della logica di import)
9.  **Utente (Completato):** Dichiara che le righe nel file di paghe non sono duplicati sono corretti, confermando l'aspettativa di un record per riga.
8.  **Utente (Completato):** Carica il file  e segnala la discrepanza nel conteggio dei record importati.
7.  **Utente (PENDING):** Chiede di rimuovere il modale dal pulsante Ricalcola progressivi dal 2023 e di usare il filtro dipendente già presente sulla pagina. (Status: Completato, ma un errore JS è stato segnalato , poi risolto).
6.  **Utente (PENDING):** Chiede modifiche alla pagina Documenti: estendere la data di ricerca al 2021, chiarire il funzionamento e aggiungere parole chiave configurabili per creare cartelle dinamiche. (Status: Completato).
5.  **Utente (PENDING):** Chiede di filtrare la vista per mostrare solo le paghe dal 2023 dopo il ricalcolo e di aggiungere un pulsante di reset. (Status: Completato).
4.  **Utente (PENDING):** Riguardo ai progressivi, chiarisce che il calcolo deve partire dal 01/01/2023 ma vuole che il filtro sia attivato da un pulsante. (Status: Completato).
3.  **Utente (Completato):** Chiarisce la logica del saldo progressivo, affermando che non deve resettarsi a fine anno ma essere continuo dall'assunzione. (Status: Implementato, poi sovrascritto dalla richiesta successiva).
2.  **Utente (PENDING):** Segnala che il saldo progressivo per Dicembre 2025 non corrisponde e chiede di applicare la logica di calcolo corretta a tutta la pagina e anche alla Prima Nota Cassa/Banca. (Status: Corretto con reset annuale, poi modificato di nuovo).
1.  **Utente (PENDING):** Chiede di controllare i dati per la dipendente CAROTENUTO ANTONELLA perché il saldo di dicembre è errato. (Status: Analizzato e Corretto).

**Project Health Check:**
*   **Broken**:
    *   La logica di importazione del file paghe () non soddisfa i requisiti dell'utente.
    *   Il parsing degli F24 scaricati via email.
*   **Mocked**: Nessuno.

**3rd Party Integrations**
*   **Google/Gmail (IMAP)**: Per scaricare allegati email.
*   **pdfplumber**: Per il parsing di PDF.
*   **pandas/openpyxl**: Per leggere file Excel ().

**Testing status**
-   **Testing agent used after significant changes**: NO
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: Nessuno.
-   **Known regressions**: Nessuna regressione nota, ma il problema dell'architettura con file duplicati rimane un rischio elevato.

**Credentials to test flow:**
-   **Email User**: 
-   **Email App Password**:  (disponibile in  sotto ).

**What agent forgot to execute**
-   L'agente non ha ancora proposto all'utente un piano per il refactoring dei file duplicati, nonostante sia una causa ricorrente di problemi.
-   La funzionalità Azioni nella pagina  è stata spiegata ma non è stata implementata la logica per renderla funzionale (es. spostare effettivamente un documento processato).</analysis>
