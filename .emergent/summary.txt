<analysis>**original_problem_statement:**
L'utente ha richiesto una serie di funzionalità e una ristrutturazione completa del codice.
1.  **Funzionalità Commercialista**: Creare una sezione per inviare documenti (Prima Nota Cassa, Fatture Pagate, Carnet Assegni) in formato PDF all'email del commercialista. Deve includere un alert automatico mensile.
2.  **Stampa Carnet**: Risolvere un bug per cui la stampa di un carnet di assegni stampava tutto invece del singolo carnet selezionato.
3.  **Standardizzazione Terminologia**: Sostituire la parola Contanti con Cassa in tutta l'applicazione.
4.  **UI Mobile**: Creare viste semplificate e mobile-first per le pagine  e , con focus su leggibilità e inserimento rapido tramite card.
5.  **Generazione PDF Mobile**: Sulla vista mobile delle fatture, il click su una riga deve generare e scaricare un PDF della fattura in formato standard italiano, invece di mostrare i dettagli.
6.  **Ristrutturazione Architettura (Richiesta Principale)**: L'utente ha richiesto di ristrutturare l'intero codice per renderlo più modulare, con un'architettura chiara e relazionale. Questo include:
    *   Spostare la logica di business dai router a un service layer.
    *   Implementare controlli di sicurezza (es. impedire l'eliminazione di fatture pagate).
    *   Chiarire e centralizzare i flussi di dati (es. dal caricamento XML alle sezioni interessate).
    *   Consolidare il codice frontend usando hooks condivisi.

**User's preferred language**: Italiano

**what currently exists?**
L'agente ha implementato con successo tutte le richieste di funzionalità dell'utente e ha iniziato la ristrutturazione del codice.
- **Backend**:
    - È stato creato un nuovo router  e una pagina frontend  che permette di inviare via email (usando la configurazione SMTP esistente) i PDF di Prima Nota, Fatture e Carnet.
    - È stato implementato un sistema di alert per l'invio dei documenti al commercialista.
    - Il termine Contanti è stato sostituito con Cassa in vari endpoint e logiche.
    - **È iniziata la ristrutturazione (Fase 1 completata)**: È stato creato un service layer () e un modulo per le regole di business (). La logica di sicurezza per impedire l'eliminazione di fatture già pagate è stata implementata e testata con successo, correggendo il codice in diversi router (, ) dove esistevano endpoint di eliminazione duplicati.
    - Sono stati creati i file di base per le Fasi 2, 3 e 4 della ristrutturazione.
- **Frontend**:
    - È stato corretto un file corrotto () e implementata la stampa PDF per singolo carnet.
    - Sono state create viste mobile-first dedicate per  e  (, ), che vengono renderizzate condizionalmente sui dispositivi mobili.
    - La vista  ora genera e scarica un PDF al tocco di una fattura, utilizzando .
    - L'interfaccia mobile di  è stata ottimizzata per essere più compatta e usabile su un unico schermo.
- **Bug Risolti**:
    - **La regressione critica della pagina  (dati non caricati) è stata verificata e CONFERMATA RISOLTA.** La pagina ora funziona correttamente.

**Last working item**:
- **Last item agent was working**: L'agente stava eseguendo un piano di ristrutturazione del codice in più fasi approvato dall'utente. Aveva appena completato la Fase 1 (creazione del service layer e implementazione delle regole di sicurezza per le fatture) e stava iniziando le fasi successive.
- **Status**: IN PROGRESS
- **Agent Testing Done**: Y (L'agente ha testato con successo la nuova regola di sicurezza che impedisce l'eliminazione di fatture pagate tramite  e ha verificato che le fatture non pagate possono essere eliminate).
- **Which testing method agent to use?**: backend testing agent. L'agente di test dovrebbe:
    1. Verificare che i nuovi endpoint di eliminazione sicura per ,  e  funzionino come previsto (impedendo la cancellazione di item bloccati).
    2. Eseguire test di regressione per assicurarsi che la creazione dei nuovi service non abbia interrotto la funzionalità esistente delle fatture.
- **User Testing Done**: N

**All Pending/In progress Issue list**:
- **Issue 1: Discrepanza Conteggio Fatture (P2)**
    - **Description**: Problema ereditato da un fork precedente. L'utente segnala 1326 fatture attese per il 2025, ma il database ne contiene 1328. Non è stato ancora affrontato.
    - **Status**: NOT STARTED
    - **Is recurring issue?**: Y
    - **Should Test frontend/backend/both after fix?**: backend
- **Issue 2: Riconoscimento POS in Riconciliazione (P2)**
    - **Description**: Problema ereditato. La logica per abbinare le operazioni POS (INC.POS, INCAS. TRAMITE P.O.S) dall'estratto conto bancario non è stata completamente verificata.
    - **Status**: NOT STARTED
    - **Is recurring issue?**: N
    - **Should Test frontend/backend/both after fix?**: both

**In progress Task List**:
- **Task 1: Completare Ristrutturazione Architettura (Fasi 2, 3, 4) (P0)**
    - **Where to resume**: L'agente ha creato la struttura dei file per le fasi successive. Il prossimo passo è popolare questi file con la logica effettiva.
        - **Fase 2**: Integrare le  negli endpoint di ,  e  per aggiungere i controlli di sicurezza (es. non eliminare movimenti consolidati).
        - **Fase 3**: Implementare la logica in  per gestire flussi di dati complessi (es. Corrispettivo XML -> Calcolo IVA -> Finanziaria) e integrarla nei router pertinenti.
        - **Fase 4**: Iniziare a migrare la logica di data-fetching dei componenti frontend (es. , ) nel nuovo hook condiviso .
    - **What will be achieved with this?**: Un'applicazione più robusta, sicura, manutenibile e con meno codice duplicato.
    - **Status**: IN PROGRESS
    - **Should Test frontend/backend/both after fix?**: both

**Upcoming and Future Tasks**
- **Upcoming Tasks**:
    - **(P1) Filtro Anno Globale**: Implementare un selettore di anno nella  che influenzi i dati visualizzati in tutta l'applicazione.
    - **(P1) Implementare Modulo Bilancio**: Creare la sezione per lo Stato Patrimoniale e il Conto Economico.
- **Future Tasks**:
    - **(P2) Associazione Automatica Dati Fornitore**: Progettare la logica per associare automaticamente un nuovo fornitore a fatture e movimenti esistenti.
    - **(P2) Popolare Magazzino da Fatture XML**: Estrarre i prodotti dalle fatture d'acquisto per aggiornare l'inventario.

**Completed work in this session**
- **Funzionalità Commercialista**: Creata nuova sezione con invio PDF via email.
- **Risoluzione Bug Stampa**: Corretta la stampa del singolo carnet di assegni.
- **Risoluzione Bug Critico **: Confermato che la pagina ora carica correttamente i dati.
- **UI Mobile per  e **: Create viste responsive e semplificate.
- **Generazione PDF Mobile**: Implementata la creazione di PDF al tocco sulle fatture nella vista mobile.
- **Standardizzazione Contanti -> Cassa**: Termine aggiornato in tutta l'applicazione.
- **Inizio Ristrutturazione Backend (Fase 1)**: Creato service layer e implementato controllo di sicurezza per impedire l'eliminazione di fatture pagate.

**Earlier issues found/mentioned but not fixed**
- **Issue 1: Discrepanza Conteggio Fatture**: Problema secondario ereditato e non ancora affrontato.
- **Issue 2: Riconoscimento POS in Riconciliazione**: Problema secondario ereditato e non ancora affrontato.

**Known issue recurrence from previous fork**
- **Issue recurrence in previous fork**: La pagina  non caricava i dati.
- **Recurrence count**: 2
- **Status**: RESOLVED

**Code Architecture**


**Key Technical Concepts**
- **Backend Service Layer**: È in corso una ristrutturazione per spostare la logica di business dai router FastAPI a classi di servizi dedicate. Questo migliora la separazione delle responsabilità e la riusabilità del codice.
- **Business Rule Enforcement**: Implementazione di controlli di sicurezza (es. non eliminare fatture pagate) in un modulo centralizzato () che viene invocato prima delle operazioni sul database.
- **Conditional Rendering (Mobile vs Desktop)**: Utilizzo di un custom hook  per rilevare la larghezza dello schermo e renderizzare un componente specifico per la versione mobile () o desktop.
- **Client-Side PDF Generation**: Utilizzo delle librerie  e  per generare dinamicamente documenti PDF direttamente nel browser dell'utente.
- **Architectural Cleanup**: Identificazione e consolidamento di logica duplicata, in particolare più endpoint di eliminazione per la stessa risorsa sparsi in file diversi.

**All files of reference**
-  (Nuova logica di sicurezza)
-  (Router principale per le fatture, modificato con i nuovi controlli)
-  (Altro router fatture, modificato)
-  (Logica di rendering condizionale)
-  (Nuova UI mobile per le fatture)
-  (Logica di rendering condizionale)
-  (Nuova UI mobile per la prima nota)
-  (Nuova pagina)
-  (Nuovo router)
-  (Nuovo documento che descrive la ristrutturazione)
-  (Aggiornato con le nuove funzionalità)

**Critical Info for New Agent**
- **La priorità assoluta è continuare con la ristrutturazione del codice come richiesto dall'utente.** Le Fasi 2, 3 e 4 sono state approvate e sono il task principale in corso.
- Il backend si trova in uno stato di transizione: parte della logica è nei nuovi services, ma molta è ancora nei routers. L'obiettivo è spostare tutta la logica di business nei services.
- Il bug più critico () è stato risolto. Ora il focus è sul miglioramento strutturale e sulla sicurezza.
- Quando si aggiungono controlli di sicurezza (es. eliminazione), bisogna fare attenzione a  per trovare tutti gli endpoint duplicati che potrebbero bypassare la nuova logica, come è successo per le fatture.

**documents and test reports created in this job**
- 
- 
- 

**Last 10 User Messages and any pending HUMAN messages**
1.  **LATEST**: Procedi con la fase 2 poi 3 e poi 4 - Approvazione per continuare la ristrutturazione.
2.  Si procedi fase per fase - Approvazione iniziale per il piano di ristrutturazione.
3.  **Richiesta di Ristrutturazione**: L'utente chiede una ristrutturazione completa e metodica del codice.
4.  **Richiesta PDF Fattura Mobile**: Sulla vista mobile, cliccare una fattura deve scaricare il PDF, non mostrare dettagli.
5.  **Feedback UI Mobile**: Richiesta di rendere la UI mobile di Prima Nota più compatta.
6.  **Richiesta UI Mobile Prima Nota**: Creare una vista mobile per Prima Nota con solo card di inserimento.
7.  **Richiesta UI Mobile Fatture**: Creare una vista mobile semplificata per le Fatture.
8.  **Richiesta Correzioni**: Sostituire Contanti con Cassa e risolvere i bug prima di procedere.
9.  **Richiesta Funzionalità Commercialista**: Stampa carnet, PDF, sezione Commercialista, invio email e alert.
10. **Richiesta precedente**: 

**Project Health Check:**
- **Broken**: Nessuna funzionalità critica è rotta.
- **In Refactoring**: L'architettura del backend è in fase di transizione da un modello con logica nei router a un modello con service layer. Questo significa che coesistono entrambi gli stili di codice.

**3rd Party Integrations**
- Nessuna nuova integrazione. Il sistema di invio email utilizza la configurazione SMTP preesistente (Gmail).

**Testing status**
- **Testing agent used after significant changes**: YES (utilizzato per verificare la nuova funzionalità Commercialista).
- **Troubleshoot agent used after agent stuck in loop**: NO
- **Test files created**: Nessuno
- **Known regressions**: Nessuna. La regressione precedente () è stata risolta.

**Credentials to test flow:**
- Nessuna credenziale speciale richiesta. L'app utilizza dati di test interni.

**What agent forgot to execute**
- L'agente non ha dimenticato nulla di significativo. Ha seguito le richieste dell'utente in modo sequenziale e metodico. L'unica cosa da notare è che le Fasi 2, 3 e 4 della ristrutturazione sono state solo abbozzate con la creazione di file placeholder; la logica effettiva deve ancora essere implementata.</analysis>
