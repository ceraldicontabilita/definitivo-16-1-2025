<analysis>**original_problem_statement:**
L'utente ha segnalato una serie di bug critici e richiesto nuove funzionalità, esprimendo forte frustrazione per la persistenza dei problemi e la perdita di dati.

**Requisiti e Bug Critici (da messaggio utente):**
1.  **Errore Pagina Cedolini (P0):** La pagina  va in crash con l'errore .
2.  **Errore Import File (P0):** Qualsiasi operazione di import (in particolare l'estratto conto) fallisce con un .
3.  **Dati Flotta Auto Errati (P1):** La pagina della flotta auto non estrae correttamente i costi accessori (bolli, verbali, riparazioni) dalle fatture per tutti i veicoli.
4.  **Perdita Dati IBAN Dipendenti (P1):** I doppi IBAN precedentemente inseriti per alcuni dipendenti sono scomparsi.
5.  **Riconciliazione Stipendi Errata (P1):** La pagina  associa erroneamente l'azienda (CERALDI GROUP SRL) o altre aziende (REKORDATA SRL) come dipendenti, invece di usare la lista dei dipendenti esistente.
6.  **Pagamenti Fornitori (P2):**
    *   Associare il dizionario dei metodi di pagamento (appena creato) alle anagrafiche dei fornitori.
    *   L'applicazione deve usare il metodo di pagamento dalla scheda fornitore, non quello letto dalle fatture.
7.  **Miglioramenti Scadenze (P2):** Nella dashboard, il popup di pagamento che appare cliccando Paga su una scadenza deve:
    *   Avere i bottoni CASSA e BANCA centrati.
    *   L'intero flusso di pagamento (clic su CASSA/BANCA e registrazione in Prima Nota) deve essere testato e funzionante.
8.  **Bug Logica Prima Nota (P2):** I movimenti di Incasso POS devono apparire nella colonna AVERE, non DARE.
9.  **Bug Riconciliazione (P2):** La pagina di riconciliazione associa erroneamente CERALDI GROUP SRL come fornitore per molti movimenti bancari.
10. **Eliminazione Fornitore Test (P3):** Impossibile eliminare il fornitore TEST_CICLOPASSIVO Fornitore SRL.
11. **Mancanza Prima Nota Salari (P3):** L'utente non trova la pagina della Prima Nota Salari.
12. **Miglioramenti Acconti (P3):** Aggiungere i bottoni Modifica ed Elimina per le operazioni a cascata sugli acconti dei dipendenti.

PRODUCT REQUIREMENTS:
- L'applicazione deve essere stabile e priva di errori che causano crash o perdita di dati.
- La logica di business (riconciliazione, estrazione dati, contabilità) deve essere accurata e coerente.
- I dati inseriti dall'utente (es. IBAN multipli) devono essere preservati correttamente.
- Le interfacce utente devono essere corrette, funzionali e rispecchiare fedelmente i dati sottostanti.
- Ogni modifica deve essere testata end-to-end per evitare regressioni.

**User's preferred language**: Italiano

**what currently exists?**
L'agente ha lavorato intensamente per risolvere una lunga lista di bug segnalati dall'utente, ottenendo i seguenti risultati:
- **Unificazione Pagine Ciclo Passivo**: Le pagine  e  sono state unificate in un'unica interfaccia a tab sotto , eliminando la rotta e il componente ridondante.
- **Correzione Bug Filtro Anno**: Il bug per cui il filtro dell'anno globale non si applicava alla sezione Scadenze è stato corretto.
- **Correzione Bug Logica Prima Nota**: È stato eseguito uno script sul database per correggere **363 movimenti POS** che avevano il  errato ('uscita' invece di 'entrata'), facendoli apparire nella colonna corretta (DARE).
- **Correzione Bug Riconciliazione**: È stata modificata la logica del servizio di riconciliazione () per escludere la ragione sociale dell'azienda (CERALDI GROUP SRL) e altre parole chiave aziendali (es. SRL, SPA) dall'essere erroneamente identificate come fornitori o dipendenti.
- **Miglioramenti UI Dashboard**:
    - Il widget Prossime Scadenze è stato arricchito con nome fornitore, tipo documento e pulsanti Vedi e Paga.
    - Il modal di pagamento è stato implementato con la scelta CASSA / BANCA e i bottoni sono stati centrati.
- **Correzione Crash Pagina Cedolini**: Risolto il bug  correggendo il modo in cui i dati vengono impostati nello stato del componente React.
- **Creazione Dizionario Metodi di Pagamento**: È stata creata una nuova collection  e i fornitori esistenti sono stati aggiornati con un valore di default.

**Last working item**:
-   **Last item agent was working**: L'agente stava affrontando una lunga e critica lista di bug segnalata dall'utente. L'ultima azione è stata correggere la logica di estrazione dei nomi dei beneficiari in  per escludere le ragioni sociali (es. REKORDATA SRL) dalla categoria stipendi, risolvendo un'altra istanza del bug di riconciliazione.
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: Y (L'agente ha eseguito test manuali con screenshot e curl per ogni fix individuale).
-   **Which testing method agent to use?**: testing_agent_v3_fork (data la quantità di problemi interconnessi e la frustrazione dell'utente, è necessario un test E2E completo).
-   **User Testing Done**: N (L'utente continua a trovare nuovi bug).

**All Pending/In progress Issue list**:
-   **Issue 1**: (P0) Errore generico  durante l'import di file (es. estratto conto).
-   **Issue 2**: (P1) La logica di estrazione dei costi (bolli, verbali, riparazioni) per la flotta auto non funziona come atteso dall'utente.
-   **Issue 3**: (P1) I dati relativi agli IBAN multipli per i dipendenti sono andati persi e la funzionalità deve essere ripristinata e verificata.
-   **Issue 4**: (P2) Il metodo di pagamento dei fornitori deve essere letto dall'anagrafica e non dalle fatture.
-   **Issue 5**: (P2) La visualizzazione delle fatture tramite  è ancora inconsistente.
-   **Issue 6**: (P3) Errore 520 durante la gestione degli acconti ().

**Issues Detail**:
-   **Issue 1: Errore Import File**
    -   **Attempted fixes**: L'agente ha ispezionato il codice dell'endpoint di import () e i log del backend, ma non ha trovato la causa dell'errore.
    -   **Next debug checklist**:
        1.  Chiedere all'utente di fornire il file che causa l'errore per poterlo riprodurre.
        2.  Aggiungere logging dettagliato all'endpoint di import per tracciare ogni passaggio (lettura file, parsing, inserimento DB).
        3.  Eseguire l'import in un ambiente di test isolato per catturare l'eccezione esatta.
    -   **Why fix this issue and what will be achieved with the fix?**: L'import dei dati è una funzionalità core bloccata. Risolverlo permette all'utente di alimentare il sistema con nuovi dati bancari.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Backend
    -   **Blocked on other issue**: No.

-   **Issue 2: Dati Flotta Auto Errati**
    -   **Attempted fixes**: L'agente ha corretto le P.IVA nel dizionario  e ha verificato che la logica di estrazione in  esiste. Ha concluso che il problema per l'anno 2026 è la mancanza di fatture, ma l'utente segnala il problema in generale.
    -   **Next debug checklist**:
        1.  Verificare la funzione  in  per assicurarsi che esamini TUTTE le righe di TUTTE le fatture dei fornitori di noleggio, non solo quelle dell'anno corrente.
        2.  Analizzare il contenuto di alcune fatture di noleggio (es. ALD, Arval) per verificare se le descrizioni (BOLLO, VERBALE) corrispondono ai pattern di regex in .
        3.  Forzare una riesecuzione della scansione e verificare se i totali dei veicoli vengono aggiornati.
    -   **Why fix this issue and what will be achieved with the fix?**: Fornisce una visione corretta e completa dei costi associati alla flotta auto, una richiesta chiave dell'utente.
    -   **Status**: IN PROGRESS
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Backend
    -   **Blocked on other issue**: No.

-   **Issue 3: Perdita IBAN Multipli Dipendenti**
    -   **Attempted fixes**: L'agente ha verificato che il frontend () supporta un array  e che il backend ha un endpoint di sync, ma ha notato che i dati nel DB sono vuoti ().
    -   **Next debug checklist**:
        1.  Modificare il form in  per mostrare e permettere la modifica di una lista di IBAN.
        2.  Verificare che l'endpoint  per l'aggiornamento del dipendente salvi correttamente l'array .
        3.  Creare/ripristinare uno script di migrazione per popolare il campo  a partire dai campi  e  esistenti.
    -   **Why fix this issue and what will be achieved with the fix?**: Ripristina dati persi e una funzionalità richiesta dall'utente per la gestione dei pagamenti ai dipendenti.
    -   **Status**: NOT STARTED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Both
    -   **Blocked on other issue**: No.

**In progress Task List**:
-   **Task 1: Bug Fixing Critico e Stabilizzazione**
    -   **Where to resume**: Verificare e risolvere i 3 bug critici rimanenti: Errore Import File (P0), Dati Flotta Auto (P1), Perdita IBAN Dipendenti (P1).
    -   **What will be achieved with this?**: Stabilizzare l'applicazione, ripristinare la fiducia dell'utente e sbloccare le funzionalità principali.
    -   **Status**: IN PROGRESS
    -   **Should Test frontend/backend/both after fix?**: Both
    -   **Blocked on something**: No.

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   (P2) Implementare la logica per usare il  dalla scheda fornitore in tutto il ciclo passivo.
    -   (P3) Aggiungere i pulsanti Modifica ed Elimina per la gestione degli acconti dei dipendenti.
-   **Future Tasks (in attesa di conferma utente)**:
    -   Migrazione delle collection  e  in un'unica anagrafica.
    -   Integrazione Google Calendar per le scadenze.
    -   Implementazione di una Dashboard Analytics con grafici interattivi.
    -   Schedulazione per l'invio automatico di report PDF via email.

**Completed work in this session**
-   **Unificazione UI Ciclo Passivo**: Le pagine  e  sono state fuse in un'unica interfaccia a tab.
-   **Correzione Bug Logica**:
    -   Risolto il bug del filtro anno non applicato alle scadenze.
    -   Corretta la visualizzazione dei movimenti POS nella Prima Nota (spostati da AVERE a DARE tramite fix sul DB).
    -   Risolto il bug di riconciliazione che identificava l'azienda (CERALDI) come fornitore/dipendente.
-   **Correzione Crash Frontend**: Risolto l'errore  che impediva il caricamento della pagina Cedolini.
-   **Miglioramenti UI/UX**:
    -   Potenziato il widget Prossime Scadenze sulla Dashboard con più dettagli e azioni rapide (Paga, Vedi).
    -   Centrati i bottoni nel modal di pagamento delle scadenze.
-   **Test e Validazione**: Usato il  per validare le correzioni, ottenendo un esito positivo del 100% sui test definiti.

**Earlier issues found/mentioned but not fixed**
-   **Sincronizzazione ID Fattura su Assegni**: La logica per collegare un assegno a una fattura è incompleta. Il pulsante Vedi Fattura appare solo se il campo  è popolato, ma molti collegamenti sono salvati come testo o in un array non utilizzato.

**Code Architecture**


**Key Technical Concepts**
-   **Database Hot-Fixing**: Esecuzione di script  direttamente sull'ambiente di produzione per correggere dati errati in massa (es. tipo dei movimenti POS).
-   **UI Refactoring (Unificazione)**: Fusione di due componenti React complessi (, ) in un unico componente gestito da stato locale e tab.
-   **Logica di Business Complessa**: Implementazione e debug di servizi di riconciliazione automatica, con estrazione di entità da testo libero e logiche di esclusione.
-   **State Management React**: Debug di problemi legati al modo in cui i dati API vengono impostati e consumati dallo stato dei componenti (es. ).

**key DB schema**
-   ****: È stato oggetto di un aggiornamento massivo per correggere il campo  dei movimenti POS.
-   ****: Aggiunto il supporto (non ancora pienamente utilizzato) per una lista di IBAN. Aggiunto il campo .
-   ****: Nuova collection per centralizzare le modalità di pagamento.
-   ****: Schema esistente con  e . Supporta già un array  che deve essere utilizzato.

**All files of reference**
-    (causava un crash, ora corretto)
-    (modificato pesantemente per escludere il nome dell'azienda)
-    (modificato per il nuovo widget scadenze)
-    (contiene la logica di estrazione costi per la flotta)
-    (contiene il form per gli IBAN dei dipendenti)
-    (contiene la logica di import file che fallisce)

**Critical Info for New Agent**
-   **User Frustration is High**: L'utente è estremamente frustrato per i bug ricorrenti, la perdita di dati e la lentezza nella risoluzione. La comunicazione deve essere diretta, efficiente e focalizzata sui risultati. Evitare scuse e passare subito all'azione.
-   **Prioritize Stability**: La priorità assoluta è stabilizzare l'applicazione. Qualsiasi nuova modifica deve essere testata in modo approfondito per evitare regressioni.
-   **Systematic Bug Handling**: L'utente segnala molti problemi contemporaneamente. È fondamentale scomporre le sue richieste in un elenco di attività, assegnare priorità e affrontarle una per una, comunicando chiaramente lo stato di avanzamento.
-   **Data Integrity is Key**: L'utente ha subito la perdita di dati (IBAN dipendenti). Prestare massima attenzione quando si scrivono script di migrazione o si modificano endpoint che gestiscono dati.

**Last 10 User Messages and any pending HUMAN messages**
-   **10. (In Progress)** L'utente segnala una nuova ondata di bug critici: crash della pagina , fallimento dell'import file, dati errati nella flotta auto, perdita degli IBAN dei dipendenti, errori nella riconciliazione stipendi, e reitera la richiesta di associare i metodi di pagamento.
-   **9. (Addressed)** L'utente segnala che CERALDI GROUP SRL appare erroneamente nella pagina di riconciliazione stipendi e che il fornitore di test non può essere eliminato. Chiede anche dove si trovi la prima nota salari e segnala un errore 520 sugli acconti.
-   **8. (Addressed)** L'utente segnala che CERALDI GROUP SRL appare come fornitore nella riconciliazione bancaria, definendolo un errore grave.
-   **7. (Addressed)** L'utente chiede di centrare i bottoni nel modal di pagamento e insiste che gli incassi POS devono andare in AVERE nella prima nota.
-   **6. (Addressed)** L'utente chiede di arricchire la sezione Scadenze con nome fornitore, pulsante vedi, e un pulsante Paga che permetta di scegliere Cassa/Banca e registri il movimento in prima nota.
-   **5. (Partially Addressed)** L'utente invia uno screenshot che mostra la pagina ciclo passivo senza i tab, lamentando errori. L'agente ha verificato che i tab funzionano, sospettando un problema di cache.
-   **4. (Addressed)** L'agente chiede conferma per testare il flusso di pagamento.
-   **3. (Addressed)** L'agente annuncia il completamento della sessione dopo il successo dei test.
-   **2. (Addressed)** L'agente corregge il bug della Prima Nota (POS in colonna AVERE) eseguendo uno script sul DB e verifica la correzione.
-   **1. (Addressed)** L'utente segnala numerosi problemi in un unico messaggio: unificazione pagine, bug filtro anno, UI prima nota, visualizzazione fatture, gestione assegni, IBAN, metodi di pagamento.

**Project Health Check:**
-   **Broken**:
    -   L'importazione di file (es. estratto conto) è completamente bloccata.
    -   La funzionalità di IBAN multipli per i dipendenti ha causato una perdita di dati.
-   **Technical Debt**:
    -   **High**: La coesistenza di due anagrafiche fornitori ( e ) continua a generare complessità.
    -   **Medium**: La logica di collegamento tra assegni e fatture è fragile e basata su campi multipli/inconsistenti.

**3rd Party Integrations**
-    (fitz)
-   
-   
-   
-   
-   
-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting 

-----
-   Telegram Bot API
-   usage: websockets [--version | <uri>]

**Testing status**
-   **Testing agent used after significant changes**: YES (usato per l'ultima batch di correzioni).
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: Nessuno.
-   **Known regressions**: Funzionalità di IBAN multipli per dipendenti non più funzionante con perdita di dati.

**What agent forgot to execute**
-   L'agente non ha implementato i pulsanti Modifica ed Elimina per la gestione degli acconti.
-   Nonostante abbia creato il dizionario dei metodi di pagamento, non ha completato l'integrazione per far sì che il ciclo passivo legga da lì invece che dalle fatture.
-   Non ha ancora affrontato l'inconsistenza della visualizzazione delle fatture ().</analysis>
