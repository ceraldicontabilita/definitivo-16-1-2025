<analysis>**original_problem_statement:**
L'utente ha richiesto l'implementazione di una serie di nuove funzionalità e correzioni per un'applicazione ERP:
1.  **Pagina Documenti:** Modificare la pagina per ridurre il tempo di sincronizzazione delle email, aggiungere un campo di input per parole chiave e gestire il download in background.
2.  **Nuova Funzionalità Operazioni da Confermare:** Analizzare le email di fattura di Aruba, estrarre i dati, popolare una nuova sezione per la conferma del pagamento (Cassa/Banca/Assegno) e registrare l'operazione in Prima Nota.
3.  **Miglioramento: Riconciliazione Automatica:** Durante l'importazione delle fatture (email e XML), tentare una riconciliazione automatica con i movimenti dell'estratto conto bancario per pre-compilare il metodo di pagamento.
4.  **Nuova Funzionalità Previsioni Acquisti:** Estrarre gli articoli dalle fatture XML per creare una pagina di statistiche di consumo e previsioni di acquisto.
5.  **Correzioni Critiche:** Risolvere bug ricorrenti, inclusi un dropdown vuoto nella gestione dipendenti e problemi di parsing F24.
6.  **Refactoring:** Eliminare codice e file duplicati nel backend.
7.  **Nuove Funzionalità Contabili (Richiesta Recente):** Implementare un vasto set di moduli contabili, tra cui cedolini paga semplificati, gestione TFR, calcolo imposte, controllo di gestione, budget, indici di bilancio, bilancio civilistico, gestione cespiti, wizard di chiusura esercizio e scadenzario fornitori.

**User's preferred language**: Italiano

**what currently exists?**
*   L'applicazione ERP è stata significativamente migliorata e stabilizzata.
*   **Fix Critici:** Il bug P0 (dropdown dipendenti vuoto) e il bug P2 (parsing F24) sono stati risolti. Il dropdown ora utilizza React Query per un caricamento dati affidabile e il parser F24 è stato corretto.
*   **Funzionalità Previsioni Acquisti:** La funzionalità è completa. Il frontend mostra statistiche di consumo (medie giornaliere/settimanali), confronto con l'anno precedente e una scheda di previsione dei costi futuri. Il backend popola correttamente i dati storici dalle fatture XML esistenti.
*   **Refactoring Backend:** È stato eseguito un importante refactoring dei router backend. 58 file duplicati sono stati rimossi dalla directory , centralizzando la logica nelle sottodirectory esistenti (, , ecc.). Il sistema è stato testato con successo dopo il refactoring.
*   **Correzione Dati:** È stato identificato e risolto un grave problema di duplicazione dei dati causato da un database obsoleto (), che è stato eliminato. La collezione  è stata ripulita e ripopolata correttamente.
*   **Sistema di Alert F24:** L'endpoint per gli alert delle scadenze F24 è stato corretto e ora funziona, recuperando correttamente le scadenze da più collection (, ).
*   **Documentazione:** È stato creato un file  in  che centralizza le informazioni sull'architettura, le collection del database e i principi contabili, come richiesto dall'utente. È stato creato anche un file  con la struttura per le nuove funzionalità.

**Last working item**:
- **Last item agent was working**: L'agente stava iniziando a implementare la nuova serie di funzionalità contabili richieste dall'utente. Ha creato i file router di base per i cedolini () e il bilancio () come primi passi per la costruzione di questi nuovi moduli.
- **Status**: IN PROGRESS
- **Agent Testing Done**: N
- **Which testing method agent to use?**: both. Man mano che ogni modulo contabile viene sviluppato, richiederà test sia del backend (calcoli, logica contabile) che del frontend (UI per l'inserimento dati e la visualizzazione).
- **User Testing Done**: N

**All Pending/In progress Issue list**:
Nessun issue critico in sospeso. I bug P0 e P2 sono stati risolti.

**In progress Task List**:
- **Task 1: Implementazione dei nuovi moduli contabili (P0)**
    - **Where to resume**: L'agente ha appena creato i file  e . Il prossimo passo è iniziare a costruire la logica e gli endpoint per il primo modulo richiesto: i **Cedolini Base**.
    - **What will be achieved with this?**: L'obiettivo è implementare una suite completa di funzionalità contabili richieste dall'utente per trasformare l'applicazione in un ERP più completo. I moduli da implementare sono:
        1.  **Cedolini Base:** Inserimento ore/giorni -> stima busta paga e costo azienda.
        2.  **Gestione TFR**.
        3.  **Calcolo IRES/IRAP** (bilancino sommario).
        4.  **Controllo di Gestione**.
        5.  **Budget Economico**.
        6.  **Indici di Bilancio** (versione semplificata).
        7.  **Bilancio Civilistico**.
        8.  **Gestione Cespiti**.
        9.  **Wizard Chiusura Esercizio**.
        10. **Scadenzario Fatture Fornitori** (solo fatture da pagare).
        11. **Calcolo IVA** (solo il calcolo, senza generazione F24).
    - **Status**: IN PROGRESS
    - **Should Test frontend/backend/both after fix?**: both
    - **Blocked on something**: No.

**Upcoming and Future Tasks**
*   **Upcoming Tasks**:
    *   Tutti gli elementi elencati nel **Task 1** della sezione In progress Task List costituiscono i prossimi task. La priorità è iniziare con Cedolini Base.
*   **Future Tasks**:
    *   **(P1) Gestione assegni multipli:** Sebbene la logica esista, l'utente ha chiesto un testing molto approfondito. Potrebbe essere necessario un task dedicato per verificarne la robustezza in tutti gli scenari.
    *   **(P2) Creare endpoint di riconciliazione batch:** Come da handoff precedente, creare un endpoint per aggiornare retroattivamente le fatture XML esistenti.
    *   **(P2) Implementare la gestione degli sconti, resi e storni:** Basato sulla ricerca di ragioneria, l'agente deve implementare la corretta gestione contabile per questi scenari.
    *   **(P2) Evitare duplicazione IVA (Fatture in Corrispettivi):** Implementare una logica (es. checkbox nella UI) per gestire le fatture emesse relative a scontrini già registrati nei corrispettivi, per evitare il doppio conteggio dell'IVA.
    *   **(P3) Centralizzare tutti gli upload:** Creare una pagina di upload generica.

**Completed work in this session**
- **Risoluzione Bug Critico (P0 - Dropdown Dipendenti):** Risolto il bug del dropdown vuoto nei modali di Gestione Dipendenti utilizzando React Query per il fetching dei dati.
- **Completamento Funzionalità (Previsioni Acquisti):** Finalizzata la pagina con statistiche, confronti anno su anno e previsioni.
- **Correzione Dati e Database:** Eliminato un database duplicato () e ripuliti i dati dei prodotti acquistati, risolvendo un problema di triplicazione dei dati segnalato dall'utente.
- **Refactoring Critico Backend:** Eliminati 58 file router duplicati dalla root del backend, migliorando la manutenibilità. Il sistema è stato testato con successo dopo il refactoring.
- **Risoluzione Bug (P2 - Parsing F24):** Corretto un bug logico nell'endpoint di sincronizzazione F24 che impediva il corretto processamento dei file scaricati.
- **Risoluzione Bug (Alert F24):** Corretto l'endpoint degli alert F24 per interrogare le collection corrette e usare i campi giusti, rendendolo funzionante.
- **Creazione Documentazione:** Creato e popolato il file  con l'architettura del sistema e una sezione sui principi di ragioneria, come richiesto.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Test automatici  falliscono:** Ereditato dall'handoff precedente, non affrontato. Sebbene il componente ora funzioni, i test automatizzati potrebbero ancora fallire.
-   **Issue 2: Definire e completare la funzionalità Vincolo:** La logica esatta deve ancora essere confermata con l'utente.
-   **Issue 3: Anno 2018 importato come 2005 (P1 dall'handoff):** L'utente ha esplicitamente richiesto di non lavorare su questo issue (Msg 165).
-   **Issue 4: Re-implementare la virtualizzazione delle tabelle (P1 dall'handoff):** L'utente ha esplicitamente richiesto di non lavorare su questo issue (Msg 165).

**Code Architecture**


**Key Technical Concepts**
- **React Query:** Utilizzato per risolvere problemi di state management e data fetching asincrono nel frontend, disaccoppiando i componenti figli dal caricamento dati del genitore.
- **Backend Refactoring:** Pulizia strutturale dei file per migliorare la manutenibilità e risolvere debiti tecnici, eliminando duplicazioni e correggendo import circolari.
- **Data Integrity and Verification:** Processo di debug che ha coinvolto il controllo di database multipli, la verifica della coerenza dei dati tra collection e la pulizia e ripopolamento dei dati per garantire l'accuratezza.
- **Dynamic API Correction:** Modifica di endpoint esistenti () per aggregare dati da più collection del database e utilizzare i campi corretti, dimostrando la capacità di adattare la logica ai dati reali.
- **Web Research for Business Logic:** Utilizzo della ricerca web per raccogliere informazioni su principi contabili complessi, che sono poi stati documentati e utilizzati per pianificare nuove funzionalità.

**key DB schema**
- Non sono state create nuove collection in questa sessione, ma le prossime attività richiederanno la creazione di schemi per: , , , , , ecc.

**changes in tech stack**
- Nessuna.

**All files of reference**
*   : **File CRITICO.** Contiene la documentazione centralizzata del progetto, inclusa la struttura del DB e le regole contabili. Il nuovo agente DEVE consultarlo.
*   : Modificato per correggere l'endpoint degli alert F24.
*   : Modificato per correggere il bug di parsing degli F24.
*   : Modificato per rimuovere il passaggio di prop .
*    e : Modificati per usare  per il fetch dei dipendenti.
*   : Oggetto di un importante refactoring con l'eliminazione di 58 file.
*    e : Nuovi file placeholder per le future funzionalità.

**Areas that need refactoring**:
*   Il parser F24 () utilizza ancora coordinate X/Y per l'estrazione dei dati, il che è fragile. Andrebbe migliorato per utilizzare pattern testuali più robusti.

**key api endpoints**
-   : Popola lo storico dei prodotti dalle fatture.
-   : (Corretto) Restituisce gli F24 scaduti o in scadenza.
-   : (Corretto) Avvia la sincronizzazione degli F24 dalle email.
-   , : (Da creare) Nuovi endpoint per i moduli contabili.

**Critical Info for New Agent**
-   **Seguire il Piano dell'Utente:** L'utente ha fornito una lista di priorità molto specifica (Msg 325) per i nuovi moduli contabili. Il task principale è implementare questa lista, iniziando dai Cedolini Base. Non deviare da questo piano.
-   **Consultare il PRD:** Il file  è la nuova fonte di verità. Contiene informazioni vitali sull'architettura e sui principi contabili da seguire. Leggilo attentamente prima di iniziare.
-   **Logica Contabile:** L'utente si aspetta che l'agente comprenda e applichi correttamente i principi della contabilità italiana. Usa i documenti in  e fai ulteriori ricerche se necessario.
-   **Cosa NON fare:** L'utente ha anche specificato chiaramente le funzionalità da NON implementare (es. invio fatture, stampa F24, libro giornale). Rispetta queste esclusioni.
-   **Refactoring Completato:** Il grosso del refactoring dei router è stato fatto e testato. Non dovrebbero esserci più problemi di file duplicati in quell'area.

**documents and test reports created in this job**
-   
-   
-    (aggiornato più volte)

**Last 10 User Messages and any pending HUMAN messages**
1.  **Msg 325:** L'utente approva il piano e fornisce una lista dettagliata e precisa delle funzionalità contabili da implementare (Cedolini, TFR, Cespiti, ecc.) e di quelle da escludere (Stampa F24, Libro Giornale, ecc.). **Stato: IN PROGRESS.**
2.  **Msg 313:** L'utente chiede all'agente di approfondire la sua conoscenza della contabilità (bilanci, diagrammi di flusso, etc.), di proporre nuove funzionalità basate su questa ricerca e di implementare le proposte. **Stato: COMPLETATO** (l'agente ha fatto ricerca e presentato la proposta).
3.  **Msg 255:** L'utente approva il resoconto dell'agente e chiede di procedere con le implementazioni proposte e di approfondire ulteriormente lo studio della ragioneria per applicarlo al software. **Stato: COMPLETATO.**
4.  **Msg 206:** L'utente chiede un'analisi approfondita di tutti i parser (specialmente F24), delle relazioni tra le pagine, e una ricerca sui principi di ragioneria per evitare duplicazioni IVA e gestire correttamente sconti/resi. **Stato: COMPLETATO.**
5.  **Msg 165:** L'utente chiede di non procedere con i task P1 (dall'handoff) e di lavorare invece sull'issue P2 (parsing F24). **Stato: COMPLETATO.**
6.  **Msg 102:** L'utente indica che la logica degli assegni multipli esiste già e chiede di integrarla, di eseguire un refactoring per eliminare codice inutile e di testare a fondo. **Stato: COMPLETATO.**
7.  **Msg 69:** L'utente ordina all'agente di eliminare il database . **Stato: COMPLETATO.**
8.  **Msg 61:** L'utente segnala un grave errore di triplicazione dei dati e richiede la creazione di un file PRD per centralizzare la conoscenza del sistema. **Stato: COMPLETATO.**
9.  **Msg 5:** L'utente approva il piano iniziale: risolvere il bug P0 e poi continuare con le Previsioni Acquisti. **Stato: COMPLETATO.**
10. **(PENDING) Msg 324 -> 325:** L'agente ha presentato la proposta di nuove funzionalità e l'utente ha risposto con la lista definitiva di cosa implementare (Msg 325). L'agente ha iniziato questo lavoro.

**Project Health Check:**
*   **Broken**: Nessuna funzionalità critica risulta bloccata.
*   **Mocked**: Nessuno.

**3rd Party Integrations**
*   **Google/Gmail (IMAP)**: Per scaricare email e allegati.
*   **pdfplumber**: Per estrarre dati da file PDF.
*   **pandas/openpyxl**: Per leggere e scrivere file Excel.
*   **beautifulsoup4**: Per parsare il contenuto HTML delle email.

**Testing status**
-   **Testing agent used after significant changes**: YES (il backend testing agent è stato usato con successo dopo il refactoring dei router).
-   **Troubleshoot agent used after agent stuck in loop**: NO
-   **Test files created**: Nessuno.
-   **Known regressions**: Nessuna.

**Credentials to test flow:**
-   **Email User**: 
-   **Email App Password**:  (disponibile in  come ).

**What agent forgot to execute**
*   Le issue ereditate Test automatici falliscono e Definire funzionalità Vincolo non sono state affrontate, poiché l'utente ha continuamente assegnato nuove priorità più alte.
*   Le issue P1 dall'handoff (Anno 2018 importato come 2005 e Re-implementare virtualizzazione) sono state esplicitamente accantonate su richiesta dell'utente.</analysis>
